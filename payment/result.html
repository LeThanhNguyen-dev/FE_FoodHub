<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết quả thanh toán</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes checkmark {
            0% { stroke-dashoffset: 100; }
            100% { stroke-dashoffset: 0; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .checkmark-path {
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            animation: checkmark 0.5s ease-in-out forwards;
        }
        .error-icon {
            animation: shake 0.5s ease-in-out;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-100 to-blue-100 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 text-center transform transition-all hover:scale-105 duration-300">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">Kết quả thanh toán</h1>
        <div id="loading" class="flex flex-col items-center">
            <div class="loader"></div>
            <p class="text-gray-600">Đang tải...</p>
        </div>
        <div id="payment-message" class="hidden"></div>
        <div id="button-container" class="mt-6"></div>
        <p id="countdown" class="text-sm text-gray-500 mt-4 hidden">Bạn sẽ được chuyển hướng sau <span id="countdown-timer">5</span> giây...</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');
            const status = urlParams.get('status');
            const messageElement = document.getElementById('payment-message');
            const loadingElement = document.getElementById('loading');
            const buttonContainer = document.getElementById('button-container');
            const countdownElement = document.getElementById('countdown');
            const countdownTimer = document.getElementById('countdown-timer');

            // Function to determine redirect URL for countdown (role-based)
            function getRedirectUrl(status, role) {
                if (role == 'ROLE_CUSTOMER') {
                    return '../home-page/html/checkout.html'; // Redirect for QR code payment (non-customer)
                }else if(role == "ROLE_CASHIER"){
                    return '../../cashier/index.html'
                }else if(role == "ROLE_WAITER"){
                    return '../../waiter/index.html';
                }
                return '../../customer/home-page.html'; // Always redirect to checkout.html for customer
            }

            if (orderId) {
                try {
                    loadingElement.classList.remove('hidden');
                    const payload = {
                        orderId: parseInt(orderId),
                        code: urlParams.get('code'),
                        id: urlParams.get('id'),
                        cancel: urlParams.get('cancel') === 'true',
                        status: status,
                        orderCode: parseInt(urlParams.get('orderCode'))
                    };
                    console.log('Sending /payments/callback payload:', payload);

                    const callbackResponse = await apiFetch('/payments/callback', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    console.log('Callback response:', callbackResponse);

                    const response = await apiFetch(`/payments/status/${orderId}`);
                    console.log('API /payments/status response:', response);

                    // Assuming role is returned in the API response or stored in sessionStorage
                    const userRole = response.result.role || sessionStorage.getItem('userRole') || 'customer'; // Fallback to 'customer'

                    messageElement.classList.remove('hidden');
                    loadingElement.classList.add('hidden');
                    countdownElement.classList.remove('hidden');

                    if (response.result.status === 'PAID') {
                        sessionStorage.setItem('paymentStatus', 'PAID');
                        // Clear cart and pending order on successful payment
                        localStorage.removeItem('cart');
                        localStorage.removeItem('pendingOrder');
                        messageElement.innerHTML = `
                            <div class="flex items-center gap-4 p-4 bg-green-100 rounded-lg">
                                <svg class="w-12 h-12" viewBox="0 0 50 50" fill="none" stroke="#10B981" stroke-width="3">
                                    <circle cx="25" cy="25" r="20" stroke="#10B981" stroke-width="3" fill="none" />
                                    <path class="checkmark-path" d="M15 25l7 7l15-15" />
                                </svg>
                                <div class="text-left">
                                    <p class="font-semibold text-green-700">Thanh toán thành công!</p>
                                    <p class="text-gray-600">Số tiền: ${response.result.amount.toLocaleString('vi-VN')} VND</p>
                                    <p class="text-gray-600">Mã giao dịch: ${response.result.transactionId || 'N/A'}</p>
                                </div>
                            </div>`;
                        buttonContainer.innerHTML = `
                            <a href="${getRedirectUrl('PAID', userRole)}" class="inline-block bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">Quay lại trang chính</a>`;
                    } else if (response.result.status === 'CANCELLED' || response.result.status === 'FAILED') {
                        messageElement.innerHTML = `
                            <div class="flex items-center gap-4 p-4 bg-red-100 rounded-lg">
                                <svg class="w-12 h-12 error-icon" viewBox="0 0 50 50" fill="none" stroke="#EF4444" stroke-width="3">
                                    <circle cx="25" cy="25" r="20" stroke="#EF4444" stroke-width="3" fill="none" />
                                    <path d="M15 15l20 20M35 15l-20 20" stroke="#EF4444" stroke-width="3" />
                                </svg>
                                <div class="text-left">
                                    <p class="font-semibold text-red-700">Thanh toán không thành công</p>
                                    <p class="text-gray-600">Giao dịch đã bị hủy hoặc gặp lỗi. Vui lòng thử lại.</p>
                                </div>
                            </div>`;
                        buttonContainer.innerHTML = `
                            <a href="../home-page/html/checkout.html" class="inline-block bg-red-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-600 transition-colors">Thử lại</a>`;
                    } else {
                        messageElement.innerHTML = `
                            <div class="flex items-center gap-4 p-4 bg-yellow-100 rounded-lg">
                                <svg class="w-12 h-12" viewBox="0 0 50 50" fill="none" stroke="#F59E0B" stroke-width="3">
                                    <circle cx="25" cy="25" r="20" stroke="#F59E0B" stroke-width="3" fill="none" />
                                    <path d="M25 15v15M25 35v5" stroke="#F59E0B" stroke-width="3" />
                                </svg>
                                <div class="text-left">
                                    <p class="font-semibold text-yellow-700">Trạng thái không xác định</p>
                                    <p class="text-gray-600">Trạng thái thanh toán: ${response.result.status}. Vui lòng kiểm tra lại sau.</p>
                                </div>
                            </div>`;
                        buttonContainer.innerHTML = `
                            <a href="${getRedirectUrl('UNKNOWN', userRole)}" class="inline-block bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">Quay lại</a>`;
                    }

                    let countdown = 5;
                    const interval = setInterval(() => {
                        countdown--;
                        countdownTimer.textContent = countdown;
                        if (countdown <= 0) {
                            clearInterval(interval);
                            window.location.href = getRedirectUrl(response.result.status, userRole);
                        }
                    }, 1000);
                } catch (error) {
                    console.error('Error checking payment status:', error.message, error.stack);
                    messageElement.classList.remove('hidden');
                    loadingElement.classList.add('hidden');
                    countdownElement.classList.remove('hidden');

                    // Assuming role is stored in sessionStorage or default to 'customer'
                    const userRole = sessionStorage.getItem('userRole') || 'customer';

                    if (status === 'PAID') {
                        sessionStorage.setItem('paymentStatus', 'PAID');
                        // Clear cart and pending order on successful payment
                        localStorage.removeItem('cart');
                        localStorage.removeItem('pendingOrder');
                        messageElement.innerHTML = `
                            <div class="flex items-center gap-4 p-4 bg-green-100 rounded-lg">
                                <svg class="w-12 h-12" viewBox="0 0 50 50" fill="none" stroke="#10B981" stroke-width="3">
                                    <circle cx="25" cy="25" r="20" stroke="#10B981" stroke-width="3" fill="none" />
                                    <path class="checkmark-path" d="M15 25l7 7l15-15" />
                                </svg>
                                <div class="text-left">
                                    <p class="font-semibold text-green-700">Thanh toán thành công!</p>
                                    <p class="text-gray-600">Số tiền: ${urlParams.get('amount') || 'N/A'} VND</p>
                                    <p class="text-gray-600">Mã giao dịch: ${urlParams.get('id') || 'N/A'}</p>
                                </div>
                            </div>`;
                        buttonContainer.innerHTML = `
                            <a href="${getRedirectUrl('PAID', userRole)}" class="inline-block bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">Quay lại trang chính</a>`;
                    } else {
                        messageElement.innerHTML = `
                            <div class="flex items-center gap-4 p-4 bg-red-100 rounded-lg">
                                <svg class="w-12 h-12 error-icon" viewBox="0 0 50 50" fill="none" stroke="#EF4444" stroke-width="3">
                                    <circle cx="25" cy="25" r="20" stroke="#EF4444" stroke-width="3" fill="none" />
                                    <path d="M15 15l20 20M35 15l-20 20" stroke="#EF4444" stroke-width="3" />
                                </svg>
                                <div class="text-left">
                                    <p class="font-semibold text-red-700">Lỗi thanh toán</p>
                                    <p class="text-gray-600">Không thể xác nhận trạng thái thanh toán. Lỗi: ${error.message}</p>
                                </div>
                            </div>`;
                        buttonContainer.innerHTML = `
                            <a href="../home-page/html/checkout.html" class="inline-block bg-red-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-600 transition-colors">Thử lại</a>`;
                    }

                    let countdown = 5;
                    const interval = setInterval(() => {
                        countdown--;
                        countdownTimer.textContent = countdown;
                        if (countdown <= 0) {
                            clearInterval(interval);
                            window.location.href = getRedirectUrl('FAILED', userRole);
                        }
                    }, 1000);
                } finally {
                    sessionStorage.removeItem('pendingOrderId');
                }
            } else {
                messageElement.classList.remove('hidden');
                loadingElement.classList.add('hidden');
                countdownElement.classList.remove('hidden');
                messageElement.innerHTML = `
                    <div class="flex items-center gap-4 p-4 bg-red-100 rounded-lg">
                        <svg class="w-12 h-12 error-icon" viewBox="0 0 50 50" fill="none" stroke="#EF4444" stroke-width="3">
                            <circle cx="25" cy="25" r="20" stroke="#EF4444" stroke-width="3" fill="none" />
                            <path d="M15 15l20 20M35 15l-20 20" stroke="#EF4444" stroke-width="3" />
                        </svg>
                        <div class="text-left">
                            <p class="font-semibold text-red-700">Lỗi</p>
                            <p class="text-gray-600">Không tìm thấy thông tin thanh toán.</p>
                        </div>
                    </div>`;
                buttonContainer.innerHTML = `
                    <a href="../home-page/html/checkout.html" class="inline-block bg-red-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-600 transition-colors">Quay lại</a>`;

                // Assuming role is stored in sessionStorage or default to 'customer'
                const userRole = sessionStorage.getItem('userRole') || 'customer';

                let countdown = 5;
                const interval = setInterval(() => {
                    countdown--;
                    countdownTimer.textContent = countdown;
                    if (countdown <= 0) {
                        clearInterval(interval);
                        window.location.href = getRedirectUrl('FAILED', userRole);
                    }
                }, 1000);
            }
        });
    </script>
    <script src="../js/fetch-api.js"></script>
</body>
</html>