<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chef Dashboard - Kitchen Management</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&family=Pacifico&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <!-- Sidebar -->
  <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileSidebar()"></div>
  <div class="sidebar d-flex flex-column" id="sidebar">
    <div class="brand">
      <h3>
        <i class="fa fa-utensils"></i>
        <span class="brand-text">FoodHub</span>
      </h3>
      <small>Kitchen Panel </small>
    </div>

    <nav class="sidebar-nav flex-fill">
      <ul class="nav flex-column">
        <li class="nav-item">
          <a href="#" class="nav-link active" onclick="handleNavClick('dashboard')">
            <i class="fas fa-tachometer-alt"></i>
            <span class="nav-text">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" onclick="handleNavClick('orders')">
            <i class="fas fa-clipboard-list"></i>
            <span class="nav-text">ƒê∆°n H√†ng</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" onclick="handleNavClick('reports')">
            <i class="fas fa-chart-line"></i>
            <span class="nav-text">B√°o C√°o Ca L√†m</span>
          </a>
        </li>
      </ul>
    </nav>

    <div class="logout-section">
      <button class="logout-btn" onclick="handleLogout()">
        <i class="fas fa-sign-out-alt"></i>
        <span class="btn-text">ƒêƒÉng Xu·∫•t</span>
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="d-flex align-items-center">
        <button class="toggle-sidebar me-3" onclick="toggleSidebar()">
          <i class="fas fa-bars"></i>
        </button>
        <h4 class="mb-0" id="pageTitle">Dashboard</h4>
      </div>
      <div class="d-flex align-items-center">
        <div class="notification-bell" onclick="toggleNotificationDropdown()">
          <i class="fas fa-bell"></i>
          <span class="notification-badge" id="notificationCount">0</span>

          <!-- Notification Dropdown -->
          <div class="notification-dropdown" id="notificationDropdown">
            <div class="notification-header">
              <h6>Th√¥ng b√°o</h6>
              <button class="clear-all-btn" onclick="clearAllNotifications()">X√≥a t·∫•t c·∫£</button>
            </div>
            <div class="notification-list" id="notificationList">
              <div class="notification-empty">
                <i class="fas fa-bell-slash"></i>
                <div>Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</div>
              </div>
            </div>
          </div>
        </div>
        <div class="dropdown">
          <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-user-circle me-2"></i><span id="chefName">ƒêang t·∫£i...</span>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="../home-page/html/profile.html#profile"><i
                  class="fas fa-user me-2"></i>H·ªì S∆°</a></li>
            <li><a class="dropdown-item" href="../home-page/html/work-schedule.html"><i
                  class="fas fa-clock me-2"></i>L·ªãch L√†m Vi·ªác</a></li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt me-2"></i>ƒêƒÉng xu·∫•t</a></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboardContent">
      <!-- Welcome Section -->
      <div class="welcome-section">
        <div class="row align-items-center">
          <div class="col-md-8">
            <p class="mb-2" id="shiftTime"><i class="fas fa-clock me-2"></i>Ca l√†m: ƒêang t·∫£i...</p>
            <p class="mb-2" id="shiftDate"><i class="fas fa-calendar me-2"></i>Ng√†y: ƒêang t·∫£i...</p>
            <p class="mb-0" id="shiftType"><i class="fas fa-sun me-2"></i>Lo·∫°i ca: ƒêang t·∫£i...</p>
          </div>
          <div class="col-md-4 text-center">
            <div class="btn-container">
              <button class="btn shift-btn" onclick="checkInShift()">
                <i class="fas fa-sign-in-alt"></i>
                <span>V√†o ca</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats Section -->
      <div class="stats-section">
        <div class="stat-card">
          <div class="stat-number" id="pendingCount">0</div>
          <div class="stat-label">ƒê∆°n Ch·ªù X·ª≠ L√Ω</div>
          <i class="fas fa-hourglass-half stat-icon"></i>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="preparingCount">0</div>
          <div class="stat-label">ƒêang Ch·∫ø Bi·∫øn</div>
          <i class="fas fa-fire stat-icon"></i>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="readyCount">0</div>
          <div class="stat-label">S·∫µn S√†ng Ph·ª•c V·ª•</div>
          <i class="fas fa-check-circle stat-icon"></i>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="avgTime">0p</div>
          <div class="stat-label">Th·ªùi Gian N·∫•u TB</div>
          <i class="fas fa-stopwatch stat-icon"></i>
        </div>
      </div>

      <div class="orders-recent-section" id="dashboardOrdersSection">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">
            <i class="fas fa-clipboard-list me-2" style="color: var(--primary)"></i>
            ƒê∆°n h√†ng g·∫ßn ƒë√¢y
          </h5>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-success" onclick="refreshDashboardOrders()">
              <i class="fas fa-sync-alt me-1"></i>
              L√†m m·ªõi
            </button>
            <button class="btn btn-primary" onclick="showOrders()">
              <i class="fas fa-eye me-1"></i>
              Xem t·∫•t c·∫£
            </button>
          </div>
        </div>

        <!-- Orders List -->
        <div class="dashboard-orders-list" id="dashboardOrdersList">
          <!-- Loading state -->
          <div class="dashboard-orders-loading" id="dashboardOrdersLoading">
            <div class="d-flex justify-content-center align-items-center py-4">
              <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <span>ƒêang t·∫£i ƒë∆°n h√†ng...</span>
            </div>
          </div>

          <!-- Orders will be rendered here -->
          <div class="dashboard-orders-content" id="dashboardOrdersContent" style="display: none;">
            <!-- Orders list will be populated by JavaScript -->
          </div>

          <!-- Empty state -->
          <div class="dashboard-orders-empty" id="dashboardOrdersEmpty" style="display: none;">
            <div class="text-center py-4">
              <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
              <h6 class="text-muted">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h6>
              <p class="text-muted small">ƒê∆°n h√†ng m·ªõi s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" style="display: none; text-align: center; padding: 50px;">
      <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i>
      <h4>Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ca l√†m vi·ªác</h4>
      <p id="errorText">ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</p>
      <button class="btn btn-primary" onclick="loadWorkSchedule()">
        <i class="fas fa-refresh me-2"></i>Th·ª≠ l·∫°i
      </button>
    </div>

    <!-- Dynamic Content Area -->
    <div id="dynamicContent" style="display: none;">
      <!-- Content will be loaded here dynamically -->
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script>
    // Global variables to store data
    let currentWorkSchedule = null;
    let currentUserInfo = null;
    let hasWorkSchedule = false;
    let audioContext = null;
    let notifications = [];
    let notificationDropdownOpen = false;
    // 2. Th√™m h√†m kh·ªüi t·∫°o AudioContext sau user gesture
    function initializeAudioContext() {
      if (!audioContext) {
        try {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          console.log('AudioContext initialized successfully');
        } catch (error) {
          console.error('Failed to initialize AudioContext:', error);
        }
      }
      console.log("AudioContext has been initialized successfully")
    }
    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function () {
      // Kh·ªüi t·∫°o AudioContext khi user click l·∫ßn ƒë·∫ßu ti√™n
      const enableAudio = () => {
        if (typeof initializeAudioContext === 'function') {
          initializeAudioContext();
        }
        // Remove listener sau khi ƒë√£ kh·ªüi t·∫°o
        document.removeEventListener('click', enableAudio);
        document.removeEventListener('keydown', enableAudio);
        document.removeEventListener('touchstart', enableAudio);
      };

      document.addEventListener('click', enableAudio);
      document.addEventListener('keydown', enableAudio);
      document.addEventListener('touchstart', enableAudio);
      
      // Load existing functions
      if (typeof updateNotificationCount === 'function') {
        updateNotificationCount();
      }
      if (typeof loadUserInfo === 'function') {
        loadUserInfo();
      }
      if (typeof loadWorkSchedule === 'function') {
        loadWorkSchedule();
      }

      // Load saved sidebar state for desktop
      if (!isMobile()) {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const wasCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';

        if (wasCollapsed) {
          sidebar.classList.add('collapsed');
          mainContent.classList.add('expanded');
        }
      }

      // Add resize event listener
      window.addEventListener('resize', handleResize);

      // Close mobile sidebar when clicking on navigation items
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function () {
          if (isMobile()) {
            setTimeout(() => {
              closeMobileSidebar();
            }, 100);
          }
        });
      });
    });

    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && isMobile()) {
        closeMobileSidebar();
      }
    });

    function isMobile() {
      return window.innerWidth <= 768;
    }

    // Function to load user information from API
    async function loadUserInfo() {
      try {
        const data = await apiFetch('/users/my-info', {
          method: 'GET',
        });

        if (data.code === 0 && data.result) {
          currentUserInfo = data.result;
          displayUserInfo(data.result);


        } else {
          console.error('Error loading user info:', data.message);
          document.getElementById('chefName').textContent = 'Chef';
        }
      } catch (error) {
        console.error('Error loading user info:', error);
        document.getElementById('chefName').textContent = 'Nh√¢n vi√™n';
      }
    }

    function initializeWebSocket(userInfo) {
      console.log('Initializing WebSocket for role:', currentWorkSchedule.role);

      // K·∫øt n·ªëi WebSocket
      connectNotificationWebSocket(currentWorkSchedule, handleWebSocketMessage);
    }

    // Function to display user information
    function displayUserInfo(userInfo) {
      // Extract username for display
      const displayName = userInfo.username || 'Nh√¢n vi√™n';

      // Update chef name in header
      document.getElementById('chefName').textContent = displayName;
    }


    // Function to handle navigation clicks
    function handleNavClick(section) {
      // Your existing navigation logic
      switch (section) {
        case 'dashboard':
          showDashboard();
          break;
        case 'orders':
          showOrders();
          break;
        case 'reports':
          showReports();
          break;
      }

      // Close mobile sidebar after navigation
      if (isMobile()) {
        closeMobileSidebar();
      }

      // Remove active class from all nav links
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });

      // Add active class to clicked nav link
      if (event && event.target) {
        event.target.closest('.nav-link').classList.add('active');
      }
    }

    function handleResize() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const mobileOverlay = document.getElementById('mobileOverlay');

      if (!isMobile()) {
        // Desktop view
        sidebar.classList.remove('mobile-open');
        mobileOverlay.classList.remove('active');
        document.body.style.overflow = '';

        // Restore desktop sidebar state
        const wasCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        if (wasCollapsed) {
          sidebar.classList.add('collapsed');
          mainContent.classList.add('expanded');
        } else {
          sidebar.classList.remove('collapsed');
          mainContent.classList.remove('expanded');
        }
      } else {
        // Mobile view
        sidebar.classList.remove('collapsed');
        mainContent.classList.remove('expanded');
      }
    }

    // Function to load work schedule from API
    async function loadWorkSchedule() {
      try {
        const data = await apiFetch('/shifts/my-work-schedule/today', {
          method: 'GET',
        });

        if (data.code === 1000 && data.result) {
          currentWorkSchedule = data.result;
          hasWorkSchedule = true;
          displayWorkSchedule(data.result);
        } else {
          // Kh√¥ng c√≥ l·ªãch l√†m vi·ªác - hi·ªÉn th·ªã th√¥ng b√°o trong welcome-section
          hasWorkSchedule = false;
          console.log("has work schedule: ", hasWorkSchedule);
          displayNoWorkSchedule();
        }

        // Lu√¥n hi·ªÉn th·ªã dashboard
        showDashboard();

        // Kh·ªüi t·∫°o dashboard orders v·ªõi tr·∫°ng th√°i ƒë√∫ng
        if (document.getElementById('dashboardOrdersSection')) {
          console.log('init order with hasWorkSchedule:', hasWorkSchedule);
          initDashboardOrders();
        }
      } catch (error) {
        console.error('Error loading work schedule:', error);
        if (document.getElementById('dashboardOrdersSection')) {
          console.log("start init dashboard order");
          initDashboardOrders();
        }
        hasWorkSchedule = false;
        console.log("has work schedule: ", hasWorkSchedule);
        displayNoWorkSchedule();
        showDashboard();
      }
    }


    function displayNoWorkSchedule() {
      // Hi·ªÉn th·ªã th√¥ng b√°o kh√¥ng c√≥ ca l√†m vi·ªác trong welcome-section
      document.getElementById('shiftDate').innerHTML =
        `<i class="fas fa-calendar me-2"></i>Ng√†y: ${new Date().toLocaleDateString('vi-VN')}`;

      document.getElementById('shiftTime').innerHTML =
        `<i class="fas fa-clock me-2"></i>Ca l√†m: B·∫°n ƒëang kh√¥ng trong ca l√†m`;

      document.getElementById('shiftType').innerHTML =
        `<i class="fas fa-info-circle me-2"></i>Tr·∫°ng th√°i: B·∫°n ƒëang kh√¥ng trong ca l√†m`;
    }

    // Function to handle work schedule errors
    function handleWorkScheduleError(error) {
      hasWorkSchedule = false;
      displayNoWorkSchedule();
      showDashboard(); // V·∫´n hi·ªÉn th·ªã dashboard
    }

    // Function to update active navigation
    function updateActiveNav(section) {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });

      // Find and activate the correct nav item
      const navItems = {
        'dashboard': '[onclick="handleNavClick(\'dashboard\')"]',
        'orders': '[onclick="handleNavClick(\'orders\')"]',
        'reports': '[onclick="handleNavClick(\'reports\')"]'
      };

      if (navItems[section]) {
        const activeNav = document.querySelector(navItems[section]);
        if (activeNav) {
          activeNav.classList.add('active');
        }
      }
    }

    function formatTimeFromISOString(isoString) {
      // T√°ch ph·∫ßn gi·ªù v√† ph√∫t t·ª´ chu·ªói "2025-07-09T17:30:00Z"
      const timePart = isoString.split('T')[1].split(':');
      return `${timePart[0]}:${timePart[1]}`; // HH:mm
    }

    // Function to display work schedule data
    function displayWorkSchedule(schedule) {
      // Parse and format date
      const scheduleDate = new Date(schedule.date);
      const formattedDate = scheduleDate.toLocaleDateString('vi-VN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });

      // Update shift information
      document.getElementById('shiftDate').innerHTML =
        `<i class="fas fa-calendar me-2"></i>Ng√†y: ${formattedDate}`;

      const formattedStartTime = formatTimeFromISOString(schedule.startTime);
      const formattedEndTime = formatTimeFromISOString(schedule.endTime);

      document.getElementById('shiftTime').innerHTML =
        `<i class="fas fa-clock me-2"></i>Ca l√†m: ${formattedStartTime} - ${formattedEndTime}`;

      // Update shift type with appropriate icon
      const shiftTypeText = getShiftTypeText(schedule.shift);
      const shiftIcon = getShiftIcon(schedule.shift);
      document.getElementById('shiftType').innerHTML =
        `<i class="fas fa-${shiftIcon} me-2"></i>Lo·∫°i ca: ${shiftTypeText}`;

      // Check work shift log to determine button display
      checkWorkShiftLog();
    }




    // Function to get shift type text in Vietnamese
    function getShiftTypeText(shift) {
      const shiftTypes = {
        'MORNING': 'Ca s√°ng',
        'AFTERNOON': 'Ca chi·ªÅu',
        'EVENING': 'Ca t·ªëi',
      };
      return shiftTypes[shift] || shift;
    }

    // Function to get appropriate icon for shift type
    function getShiftIcon(shift) {
      const shiftIcons = {
        'MORNING': 'sun',
        'AFTERNOON': 'sun',
        'EVENING': 'moon',
        'NIGHT': 'moon'
      };
      return shiftIcons[shift] || 'clock';
    }

    // Existing functions updated to check work schedule
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');

      if (isMobile()) {
        // Mobile behavior
        if (sidebar.classList.contains('mobile-open')) {
          closeMobileSidebar();
        } else {
          openMobileSidebar();
        }
      } else {
        // Desktop behavior
        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('expanded');
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
      }
    }

    function openMobileSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mobileOverlay = document.getElementById('mobileOverlay');

      sidebar.classList.add('mobile-open');
      mobileOverlay.classList.add('active');
      document.body.style.overflow = 'hidden'; // Prevent body scrolling
    }

    // Close mobile sidebar
    function closeMobileSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mobileOverlay = document.getElementById('mobileOverlay');

      sidebar.classList.remove('mobile-open');
      mobileOverlay.classList.remove('active');
      document.body.style.overflow = ''; // Restore body scrolling
    }

    function setActiveNav(element) {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });
      element.classList.add('active');
    }



    function showDashboard() {
      // Update page title
      document.getElementById('pageTitle').textContent = 'Dashboard';

      // Show dashboard content and hide others
      document.getElementById('dashboardContent').style.display = 'block';
      document.getElementById('dynamicContent').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';

      // Update active navigation
      updateActiveNav('dashboard');
    }

    // Placeholder functions for other navigation items
    function showOrders() {
      console.log('Show orders');
      updateActiveNav('orders');
    }

    function showReports() {
      console.log('Show reports');
      updateActiveNav('reports');
    }

    // WebSocket notification handling
    // H√†m x·ª≠ l√Ω WebSocket message v·ªõi th√¥ng b√°o c√≥ √¢m thanh
    function handleWebSocketMessage(data) {
      console.log('Received notification:', data);
      console.log('üì© data.message:', data.message);
      console.log('data.type:', data.type);

      // Add to notification list
      addNotificationToList(data.message, data.type || 'order');

      // Show WebSocket notification popup
      showWebSocketNotification(data.message);
    }

    // H√†m hi·ªÉn th·ªã th√¥ng b√°o WebSocket v·ªõi √¢m thanh v√† hi·ªáu ·ª©ng ƒë·∫∑c bi·ªát
    function showWebSocketNotification(message) {
      console.log("WebSocket notification: ", message);

      // Ph√°t √¢m thanh th√¥ng b√°o (c√≥ th·ªÉ thay ƒë·ªïi lo·∫°i √¢m thanh)
      playNotificationSound(); // C√≥ th·ªÉ thay ƒë·ªïi th√†nh: 'bell', 'chime', 'ping', 'success', 'gentle'

      // T·∫°o notification element
      const notification = document.createElement('div');
      notification.className = 'websocket-notification';
      notification.innerHTML = `
        <div class="websocket-notification-content">
            <span>${message}</span>
            <button class="close-btn" onclick="closeWebSocketNotification(this)">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;

      // Th√™m v√†o body
      document.body.appendChild(notification);

      // Hi·ªán notification v·ªõi animation
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);

      // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
      setTimeout(() => {
        closeWebSocketNotification(notification);
      }, 5000);
    }

    // H√†m ƒë√≥ng th√¥ng b√°o WebSocket
    function closeWebSocketNotification(element) {
      const notification = element.tagName === 'BUTTON' ? element.closest('.websocket-notification') : element;

      notification.classList.remove('show');
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }

    // H√†m ph√°t √¢m thanh th√¥ng b√°o
    function playNotificationSound() {
      // Ki·ªÉm tra n·∫øu AudioContext ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o
      if (!audioContext) {
        console.log('AudioContext ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o');
        return;
      }

      try {
        // Resume AudioContext n·∫øu b·ªã suspended
        if (audioContext.state === 'suspended') {
          audioContext.resume().then(() => {
            playChimeSound();
          }).catch(error => {
            console.log('Kh√¥ng th·ªÉ resume AudioContext:', error);
          });
        } else {
          playChimeSound();
        }
      } catch (error) {
        console.log('Kh√¥ng th·ªÉ ph√°t √¢m thanh th√¥ng b√°o:', error);
      }
    }



    function playChimeSound() {
      if (!audioContext || audioContext.state === 'closed') {
        console.log('AudioContext kh√¥ng kh·∫£ d·ª•ng');
        return;
      }

      const frequencies = [523, 659, 784]; // C, E, G

      frequencies.forEach((freq, index) => {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
        oscillator.type = 'sine';

        const startTime = audioContext.currentTime + (index * 0.15);
        gainNode.gain.setValueAtTime(0.2, startTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 1);

        oscillator.start(startTime);
        oscillator.stop(startTime + 1);
      });
    }

    // Function to update notification count
    function updateNotificationCount() {
      const notificationBadge = document.getElementById('notificationCount');
      const unreadCount = notifications.filter(n => !n.read).length;

      notificationBadge.textContent = unreadCount;
      notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';

      if (unreadCount > 0) {
        notificationBadge.classList.add('notification-pulse');
        setTimeout(() => {
          notificationBadge.classList.remove('notification-pulse');
        }, 1000);
      }
    }

    function showNotification(message, type = 'info') {
      // T·∫°o notification element
      console.log("notification: ", message);
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.innerHTML = `
        <div class="notification-content">
            <i class="fas ${getNotificationIcon(type)}"></i>
            <span>${message}</span>
        </div>
    `;

      // Th√™m v√†o body
      document.body.appendChild(notification);

      // Hi·ªán notification
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);

      // T·ª± ƒë·ªông ·∫©n sau 3 gi√¢y
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    function toggleNotificationDropdown() {
      const dropdown = document.getElementById('notificationDropdown');
      const isVisible = dropdown.classList.contains('show');
      console.log("in toggleNotificationDropdown");
      if (isVisible) {
        hideNotificationDropdown();
      } else {
        showNotificationDropdown();
      }
    }

    // Function to show notification dropdown
    function showNotificationDropdown() {
      const dropdown = document.getElementById('notificationDropdown');
      dropdown.classList.add('show');
      notificationDropdownOpen = true;

      // Mark all notifications as read
      markAllNotificationsAsRead();

      // Close dropdown when clicking outside
      setTimeout(() => {
        document.addEventListener('click', handleOutsideClick);
      }, 100);
    }

    function hideNotificationDropdown() {
      const dropdown = document.getElementById('notificationDropdown');
      dropdown.classList.remove('show');
      notificationDropdownOpen = false;

      document.removeEventListener('click', handleOutsideClick);
    }

    // Function to handle clicking outside dropdown
    function handleOutsideClick(event) {
      const dropdown = document.getElementById('notificationDropdown');
      const bell = document.querySelector('.notification-bell');

      if (!dropdown.contains(event.target) && !bell.contains(event.target)) {
        hideNotificationDropdown();
      }
    }


    function addNotificationToList(message, type = 'order') {
      const notification = {
        id: Date.now(),
        message: message,
        type: type,
        timestamp: new Date(),
        read: false
      };

      // Add to beginning of array
      notifications.unshift(notification);

      // Keep only last 50 notifications
      if (notifications.length > 50) {
        notifications = notifications.slice(0, 50);
      }

      // Update UI
      updateNotificationsList();
      updateNotificationCount();
    }

    // Function to update notifications list display
    function updateNotificationsList() {
      const listContainer = document.getElementById('notificationList');

      if (notifications.length === 0) {
        listContainer.innerHTML = `
      <div class="notification-empty">
        <i class="fas fa-bell-slash"></i>
        <div>Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</div>
      </div>
    `;
        return;
      }

      const notificationsHTML = notifications.map(notification => {
        const timeAgo = getTimeAgo(notification.timestamp);
        const typeIcon = getNotificationTypeIcon(notification.type);

        return `
      <div class="notification-item ${!notification.read ? 'unread' : ''}" 
           onclick="markNotificationAsRead(${notification.id})">
        <div class="d-flex align-items-start">
          <div class="notification-type-icon notification-type-${notification.type}">
            <i class="fas ${typeIcon}"></i>
          </div>
          <div class="notification-content flex-grow-1">
            <div class="notification-message">${notification.message}</div>
            <div class="notification-time">${timeAgo}</div>
          </div>
        </div>
      </div>
    `;
      }).join('');

      listContainer.innerHTML = notificationsHTML;
    }

    // Function to get notification type icon
    function getNotificationTypeIcon(type) {
      const icons = {
        'order': 'fa-utensils',
        'system': 'fa-info-circle',
        'alert': 'fa-exclamation-triangle',
        'success': 'fa-check-circle'
      };
      return icons[type] || 'fa-bell';
    }

    // Function to get time ago string
    function getTimeAgo(timestamp) {
      const now = new Date();
      const diffInSeconds = Math.floor((now - timestamp) / 1000);

      if (diffInSeconds < 60) {
        return 'V·ª´a xong';
      } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes} ph√∫t tr∆∞·ªõc`;
      } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours} gi·ªù tr∆∞·ªõc`;
      } else {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days} ng√†y tr∆∞·ªõc`;
      }
    }

    // Function to mark notification as read
    function markNotificationAsRead(notificationId) {
      const notification = notifications.find(n => n.id === notificationId);
      if (notification) {
        notification.read = true;
        updateNotificationsList();
        updateNotificationCount();
      }
    }

    // Function to mark all notifications as read
    function markAllNotificationsAsRead() {
      notifications.forEach(notification => {
        notification.read = true;
      });
      updateNotificationsList();
      updateNotificationCount();
    }

    // Function to clear all notifications
    function clearAllNotifications() {
      if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ th√¥ng b√°o?')) {
        notifications = [];
        updateNotificationsList();
        updateNotificationCount();
      }
    }

    function initDashboardOrders() {
      // Ki·ªÉm tra tr·∫°ng th√°i l·ªãch l√†m vi·ªác tr∆∞·ªõc khi load orders
      console.log("initDashboardOrders - hasWorkSchedule:", hasWorkSchedule);
      if (!hasWorkSchedule) {
        showDashboardNoWorkSchedule();
      } else {
        loadDashboardOrders();
      }
    }

    // Load orders for dashboard (recent orders only)
    async function loadDashboardOrders() {
      try {
        // Ki·ªÉm tra n·∫øu kh√¥ng c√≥ l·ªãch l√†m vi·ªác
        if (!hasWorkSchedule) {
          console.log("loadDashboardOrders - hasWorkSchedule:", hasWorkSchedule);
          showDashboardNoWorkSchedule();
          return;
        }

        showDashboardLoading();

        // Build query parameters for recent orders
        const params = new URLSearchParams();
        params.append('page', '0');
        params.append('size', '10'); // Only show 10 recent orders
        params.append('orderBy', 'createdAt');
        params.append('sort', 'DESC');
        // Fetch orders
        const data = await apiFetch(`/orders/chef/work-shift-orders/${currentUserInfo.id}?${params.toString()}`, {
          method: 'GET'
        });

        const orderPage = data.result;
        ordersData = orderPage.content || [];

        // Update dashboard with orders
        renderDashboardOrders(ordersData);

        if (typeof updateStats === 'function') updateStats();

      } catch (error) {
        console.error('Error loading dashboard orders:', error);
        console.log('error code: ', error.code);
        if (error.code == 1041 || error.code == 1048) {
          console.log('in error');
          showDashboardNoWorkSchedule();
        } else {
          console.log('in else');
          showDashboardError(error.message);
        }
      }
    }


    function showDashboardNoWorkSchedule() {
      console.log("in showDashboardNoWorkSchedule");
      const loadingElement = document.getElementById('dashboardOrdersLoading');
      const contentElement = document.getElementById('dashboardOrdersContent');
      const emptyElement = document.getElementById('dashboardOrdersEmpty');

      // Hide loading and content
      if (loadingElement) {
        loadingElement.style.display = 'none';
      }
      if (contentElement) {
        contentElement.style.display = 'none';
      }

      // Show no work schedule message
      if (emptyElement) {
        emptyElement.innerHTML = `
      <div class="text-center py-4">
        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
        <h6 class="text-muted">Hi·ªán t·∫°i b·∫°n ƒëang kh√¥ng trong ca l√†m</h6>
        <p class="text-muted small">ƒê∆°n h√†ng s·∫Ω hi·ªÉn th·ªã khi b·∫°n c√≥ ca l√†m vi·ªác</p>
      </div>
    `;
        emptyElement.style.display = 'block';
      }
    }

    // Render orders in dashboard
    function renderDashboardOrders(orders) {
      const loadingElement = document.getElementById('dashboardOrdersLoading');
      const contentElement = document.getElementById('dashboardOrdersContent');
      const emptyElement = document.getElementById('dashboardOrdersEmpty');

      // Hide loading
      if (loadingElement) {
        loadingElement.style.display = 'none';
      }

      if (orders.length === 0) {
        // Show empty state
        if (contentElement) {
          contentElement.style.display = 'none';
        }
        if (emptyElement) {
          emptyElement.style.display = 'block';
        }
        return;
      }

      // Show content
      if (emptyElement) {
        emptyElement.style.display = 'none';
      }
      if (contentElement) {
        contentElement.style.display = 'block';

        // Render orders
        contentElement.innerHTML = orders.map(order => `
            <div class="dashboard-order-item ${order.status.toLowerCase()}" 
                 onclick="viewOrderDetails(${order.id})">
                <div class="order-header">
                    <span class="order-id">#${order.id}</span>
                    <span class="order-time">
                        <i class="fas fa-clock me-1"></i>
                        ${formatDateTime(order.createdAt)}
                    </span>
                </div>
                <div class="order-info">
                    <div class="order-details">
                        <span class="table-number-badge">
                            <i class="fas fa-chair me-1"></i>
                            ${order.tableNumber ? `B√†n ${order.tableNumber}` : 'Mang v·ªÅ'}
                        </span>
                        <span class="order-amount">
                            <i class="fas fa-money-bill me-1"></i>
                            ${formatCurrency(order.totalAmount)}
                        </span>
                    </div>
                    <span class="status-badge status-${order.status.toLowerCase()}">
                        ${statusTranslations[order.status] || order.status}
                    </span>
                </div>
            </div>
        `).join('');
      }
    }

    function showDashboardLoading() {
      const loadingElement = document.getElementById('dashboardOrdersLoading');
      const contentElement = document.getElementById('dashboardOrdersContent');
      const emptyElement = document.getElementById('dashboardOrdersEmpty');

      if (loadingElement) {
        loadingElement.style.display = 'block';
      }
      if (contentElement) {
        contentElement.style.display = 'none';
      }
      if (emptyElement) {
        emptyElement.style.display = 'none';
      }
    }

    // Show error state
    function showDashboardError(message) {
      const loadingElement = document.getElementById('dashboardOrdersLoading');
      const contentElement = document.getElementById('dashboardOrdersContent');
      const emptyElement = document.getElementById('dashboardOrdersEmpty');

      if (loadingElement) {
        loadingElement.style.display = 'none';
      }
      if (contentElement) {
        contentElement.style.display = 'none';
      }
      if (emptyElement) {
        emptyElement.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <h6 class="text-danger">L·ªói t·∫£i ƒë∆°n h√†ng</h6>
                <p class="text-muted small">${message}</p>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshDashboardOrders()">
                    <i class="fas fa-sync-alt me-1"></i>
                    Th·ª≠ l·∫°i
                </button>
            </div>
        `;
        emptyElement.style.display = 'block';
      }
    }

    // Refresh dashboard orders manually
    function refreshDashboardOrders() {
      loadDashboardOrders();
    }

    function formatDateTime(dateString) {
      console.log("date string: ", dateString);

      // Remove 'Z' suffix if present and treat as local time
      const cleanDateString = dateString.replace('Z', '');
      const date = new Date(cleanDateString);
      const now = new Date();

      // Calculate difference in milliseconds
      const diffMs = now.getTime() - date.getTime();
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      // Format time part
      const timeStr = date.toLocaleTimeString('vi-VN', {
        hour: '2-digit',
        minute: '2-digit'
      });

      // Handle future dates (when date is in the future)
      if (diffMs < 0) {
        const absDiffMins = Math.abs(diffMins);
        const absDiffHours = Math.abs(diffHours);
        const absDiffDays = Math.abs(diffDays);

        if (absDiffMins < 60) {
          return `Trong ${absDiffMins} ph√∫t`;
        } else if (absDiffHours < 24) {
          return `Trong ${absDiffHours} gi·ªù (${timeStr})`;
        } else {
          return `Trong ${absDiffDays} ng√†y (${timeStr})`;
        }
      }

      // Handle past dates (normal case)
      if (diffMins < 1) {
        return 'V·ª´a xong';
      } else if (diffMins < 60) {
        return `${diffMins} ph√∫t tr∆∞·ªõc`;
      } else if (diffHours < 24) {
        return `${diffHours} gi·ªù tr∆∞·ªõc (${timeStr})`;
      } else if (diffDays < 7) {
        return `${diffDays} ng√†y tr∆∞·ªõc (${timeStr})`;
      } else {
        return date.toLocaleDateString('vi-VN', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        }) + ` ${timeStr}`;
      }
    }

    async function checkInShift() {
      if (!currentWorkSchedule || !currentWorkSchedule.id) {
        showNotification('Kh√¥ng c√≥ ca l√†m vi·ªác ƒë·ªÉ check-in', 'error');
        return;
      }

      if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën v√†o ca l√†m vi·ªác?')) {
        return;
      }

      try {
        const requestBody = {
          shiftId: currentWorkSchedule.id
        };

        const data = await apiFetch('/shifts/check-in', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });

        if (data.code === 1000 && data.result) {
          showNotification(data.message, 'success');

          // Disable check-in button and enable check-out button
          showCheckOutButton();

          // Reload dashboard orders since check-in might affect order visibility
          if (hasWorkSchedule) {
            loadDashboardOrders();
          }

          // Initialize WebSocket
          initializeWebSocket(currentWorkSchedule);

          // Re-check work shift log to update status display
          checkWorkShiftLog();
        } else {
          showNotification(`Check-in th·∫•t b·∫°i: ${data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`, 'error');
        }
      } catch (error) {
        console.error('Error during check-in:', error);
        showNotification(error.message, 'error');
      }
    }

    // Updated checkOutShift function
    async function checkOutShift() {
      if (!currentWorkSchedule || !currentWorkSchedule.id) {
        showNotification('Kh√¥ng c√≥ ca l√†m vi·ªác ƒë·ªÉ check-out', 'error');
        return;
      }

      if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën k·∫øt th√∫c ca l√†m vi·ªác?')) {
        return;
      }

      try {
        const requestBody = {
          shiftId: currentWorkSchedule.id
        };

        const data = await apiFetch('/shifts/check-out', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });

        if (data.code === 1000 && data.result) {
          showNotification('Check-out th√†nh c√¥ng', 'success');

          // Disable both buttons
          disableAllShiftButtons();

          // Disconnect WebSocket
          disconnectWebSocket();

          // Update dashboard to reflect no work schedule
          showDashboardNoWorkSchedule();

          // Re-check work shift log to update status display
          checkWorkShiftLog();

        } else {
          showNotification(`Check-out th·∫•t b·∫°i: ${data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`, 'error');
        }
      } catch (error) {
        console.error('Error during check-out:', error);
        showNotification(error.message, 'error');
      }
    }


    async function checkWorkShiftLog() {
      if (!currentWorkSchedule || !currentWorkSchedule.id) {
        console.log('No work schedule available');
        disableAllShiftButtons();
        return;
      }

      try {
        const data = await apiFetch(`/shifts/work-shift-log/work-schedule/${currentWorkSchedule.id}`, {
          method: 'GET'
        });

        if (data.code === 1000 && data.result) {
          // User has checked in
          const shiftLog = data.result;
          console.log('Work shift log:', shiftLog);
          if (shiftLog.checkInTime) {
            if (shiftLog.checkOutTime) {
              // User has checked out - disable both buttons
              disableAllShiftButtons();
              updateShiftStatusDisplay(shiftLog);
            } else {
              // User has checked in but not checked out - show check-out button active, check-in disabled
              showCheckOutButton();
              updateShiftStatusDisplay(shiftLog);
            }
          } else {
            showCheckInButton();
          }
        } else {
          console.error('Error checking work shift log:', data.message);
          disableAllShiftButtons();
        }
      } catch (error) {
        console.error('Error checking work shift log:', error);
        disableAllShiftButtons();
      }
    }

    // Function to show check-in button as active (clickable)
    function showCheckInButton() {
      const shiftButton = document.querySelector('.shift-btn');
      if (shiftButton) {
        shiftButton.disabled = false;
        shiftButton.onclick = checkInShift;
        shiftButton.innerHTML = `
      <i class="fas fa-sign-in-alt"></i>
      <span>V√†o ca</span>
    `;
      }
    }

    // Function to show check-out button as active (clickable)
    function showCheckOutButton() {
      console.log('in show check out button');
      const shiftButton = document.querySelector('.shift-btn');
      if (shiftButton) {
        shiftButton.disabled = false;
        shiftButton.onclick = checkOutShift;
        shiftButton.innerHTML = `
      <i class="fas fa-sign-out-alt"></i>
      <span class="btn-text">Check-out</span>
    `;
      }
    }

    // Function to show check-out button as disabled (already checked out)
    function showCheckOutButtonDisabled() {
      console.log('in show check out disable');
      const shiftButton = document.querySelector('.shift-btn');
      if (shiftButton) {
        shiftButton.disabled = true;
        shiftButton.onclick = null;
        shiftButton.innerHTML = '<i class="fas fa-check"></i> <span class="btn-text">ƒê√£ check-out</span>';
      }
    }


    // Function to disable all shift buttons
    function disableAllShiftButtons() {
      showCheckOutButtonDisabled();
    }

    // Function to update shift status display based on shift log
    function updateShiftStatusDisplay(shiftLog) {
      if (shiftLog.checkInTime) {
        const checkInTime = formatTimeFromISOString(shiftLog.checkInTime);

        let statusText = '';
        let statusIcon = '';

        if (shiftLog.checkOutTime) {
          // User has checked out
          const checkOutTime = formatTimeFromISOString(shiftLog.checkOutTime);
          statusText = `ƒê√£ ho√†n th√†nh ca (${checkInTime} - ${checkOutTime})`;
          statusIcon = 'fa-check-circle';
        } else {
          // User has checked in but not out
          statusText = `ƒê√£ check-in l√∫c ${checkInTime}`;
          statusIcon = 'fa-clock';
        }

        // Update status display
        document.getElementById('shiftType').innerHTML =
          `<i class="fas ${statusIcon} me-2"></i>Tr·∫°ng th√°i: ${statusText}`;

        // Show status badge if late
        if (shiftLog.status === 'LATE') {
          const statusBadge = document.createElement('span');
          statusBadge.className = 'badge bg-warning ms-2';
          statusBadge.textContent = 'ƒêi mu·ªôn';
          document.getElementById('shiftType').appendChild(statusBadge);
        }
      }
    }


    // Disconnect WebSocket when page unloads
    window.addEventListener('beforeunload', function () {
      disconnectWebSocket();

      // Cleanup AudioContext
      if (audioContext && audioContext.state !== 'closed') {
        audioContext.close();
      }
    });
  </script>
  <script src="js/order.js"></script>
  <script src="js/report.js"></script>
  <script src="../js/fetch-api.js"></script>
  <script src="../js/websocket.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</body>

</html>