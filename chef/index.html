<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chef Dashboard - Kitchen Management</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<!-- Sidebar -->
<div class="sidebar d-flex flex-column" id="sidebar">
  <div class="brand">
    <h3>
      <i class="fa fa-utensils"></i>
      <span class="brand-text">FoodHub</span>
    </h3>
    <small>Dashboard Chef</small>
  </div>

  <nav class="sidebar-nav flex-fill">
    <ul class="nav flex-column">
      <li class="nav-item">
        <a href="#" class="nav-link active" onclick="handleNavClick('dashboard')">
          <i class="fas fa-tachometer-alt"></i>
          <span class="nav-text">Dashboard</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" onclick="handleNavClick('orders')">
          <i class="fas fa-clipboard-list"></i>
          <span class="nav-text">ƒê∆°n H√†ng</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" onclick="handleNavClick('tables')">
          <i class="fas fa-chair"></i>
          <span class="nav-text">H√†ng ƒê·ª£i</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" onclick="handleNavClick('reports')">
          <i class="fas fa-chart-line"></i>
          <span class="nav-text">B√°o C√°o Ca L√†m</span>
        </a>
      </li>
    </ul>
  </nav>

  <div class="logout-section">
    <button class="logout-btn" onclick="handleLogout()">
      <i class="fas fa-sign-out-alt"></i>
      <span class="btn-text">K·∫øt Th√∫c Ca L√†m</span>
    </button>
  </div>
</div>

<!-- Main Content -->
<div class="main-content" id="mainContent">
  <!-- Top Bar -->
  <div class="top-bar">
    <div class="d-flex align-items-center">
      <button class="toggle-sidebar me-3" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </button>
      <h4 class="mb-0" id="pageTitle">Dashboard - Ca L√†m Vi·ªác</h4>
    </div>
    <div class="d-flex align-items-center">
      <div class="notification-bell">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" id="notificationCount">0</span>
      </div>
      <div class="dropdown">
        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="fas fa-user-circle me-2"></i><span id="chefName">ƒêang t·∫£i...</span>
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>H·ªì S∆°</a></li>
          <li><a class="dropdown-item" href="#"><i class="fas fa-clock me-2"></i>L·ªãch L√†m Vi·ªác</a></li>
          <li>
            <hr class="dropdown-divider">
          </li>
          <li><a class="dropdown-item" href="#" onclick="handleLogout()"><i
                  class="fas fa-sign-out-alt me-2"></i>K·∫øt Th√∫c Ca</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Dashboard Content -->
  <div id="dashboardContent">
    <!-- Welcome Section -->
    <div class="welcome-section">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h2 class="mb-3" id="welcomeMessage">Ch√†o b·∫°n!</h2>
          <p class="mb-2" id="shiftTime"><i class="fas fa-clock me-2"></i>Ca l√†m: ƒêang t·∫£i...</p>
          <p class="mb-2" id="shiftDate"><i class="fas fa-calendar me-2"></i>Ng√†y: ƒêang t·∫£i...</p>
          <p class="mb-0" id="shiftType"><i class="fas fa-sun me-2"></i>Lo·∫°i ca: ƒêang t·∫£i...</p>
        </div>
        <div class="col-md-4 text-center">
          <i class="fas fa-chef-hat" style="font-size: 4rem; color: rgba(255,255,255,0.8);"></i>
        </div>
      </div>
    </div>

    <!-- Stats Section -->
    <div class="stats-section">
      <div class="stat-card">
        <div class="stat-number" id="pendingCount">0</div>
        <div class="stat-label">ƒê∆°n Ch·ªù X·ª≠ L√Ω</div>
        <i class="fas fa-hourglass-half stat-icon"></i>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="preparingCount">0</div>
        <div class="stat-label">ƒêang Ch·∫ø Bi·∫øn</div>
        <i class="fas fa-fire stat-icon"></i>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="readyCount">0</div>
        <div class="stat-label">S·∫µn S√†ng Ph·ª•c V·ª•</div>
        <i class="fas fa-check-circle stat-icon"></i>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avgTime">15p</div>
        <div class="stat-label">Th·ªùi Gian N·∫•u TB</div>
        <i class="fas fa-stopwatch stat-icon"></i>
      </div>
    </div>

  </div>

  <!-- No Work Schedule Message -->
  <div id="noWorkScheduleMessage" style="display: none; text-align: center; padding: 50px;">
    <div class="alert alert-warning" role="alert" style="max-width: 600px; margin: 0 auto;">
      <i class="fas fa-calendar-times" style="font-size: 3rem; color: #856404; margin-bottom: 1rem; display: block;"></i>
      <h4 class="alert-heading">Kh√¥ng c√≥ ca l√†m vi·ªác h√¥m nay</h4>
      <p class="mb-3">H·ªá th·ªëng kh√¥ng t√¨m th·∫•y l·ªãch l√†m vi·ªác c·ªßa b·∫°n cho ng√†y h√¥m nay. ƒêi·ªÅu n√†y c√≥ th·ªÉ do:</p>
      <ul class="text-start mb-3" style="display: inline-block;">
        <li>B·∫°n kh√¥ng ƒë∆∞·ª£c ph√¢n c√¥ng ca l√†m vi·ªác h√¥m nay</li>
        <li>L·ªãch l√†m vi·ªác ch∆∞a ƒë∆∞·ª£c c·∫≠p nh·∫≠t</li>
        <li>C√≥ l·ªói trong h·ªá th·ªëng ph√¢n c√¥ng</li>
      </ul>
      <hr>
      <div class="d-flex gap-2 justify-content-center">
        <button class="btn btn-outline-primary" onclick="loadWorkSchedule()">
          <i class="fas fa-refresh me-2"></i>Th·ª≠ l·∫°i
        </button>
        <button class="btn btn-primary" onclick="contactManager()">
          <i class="fas fa-phone me-2"></i>Li√™n h·ªá qu·∫£n l√Ω
        </button>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div id="errorMessage" style="display: none; text-align: center; padding: 50px;">
    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i>
    <h4>Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ca l√†m vi·ªác</h4>
    <p id="errorText">ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</p>
    <button class="btn btn-primary" onclick="loadWorkSchedule()">
      <i class="fas fa-refresh me-2"></i>Th·ª≠ l·∫°i
    </button>
  </div>

  <!-- Dynamic Content Area -->
  <div id="dynamicContent" style="display: none;">
    <!-- Content will be loaded here dynamically -->
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script>
  // Global variables to store data
  let currentWorkSchedule = null;
  let currentUserInfo = null;
  let hasWorkSchedule = false;

  // Load data when page loads
  document.addEventListener('DOMContentLoaded', function() {
    loadUserInfo();
    loadWorkSchedule();
  });

  // Function to load user information from API
  async function loadUserInfo() {
    try {
      const data = await apiFetch('/users/my-info', {
        method: 'GET',
      });
      
      if (data.code === 0 && data.result) {
        currentUserInfo = data.result;
        displayUserInfo(data.result);
      } else {
        console.error('Error loading user info:', data.message);
        // Set default user name if API fails
        document.getElementById('chefName').textContent = 'Chef';
      }
    } catch (error) {
      console.error('Error loading user info:', error);
      // Set default user name if API fails
      document.getElementById('chefName').textContent = 'Nh√¢n vi√™n';
    }
  }

  // Function to display user information
  function displayUserInfo(userInfo) {
    // Extract username for display
    const displayName = userInfo.username || 'Nh√¢n vi√™n';
    
    // Update chef name in header
    document.getElementById('chefName').textContent = displayName;
    
    // Update welcome message if we have both user info and work schedule
    if (currentWorkSchedule) {
      updateWelcomeMessage(displayName);
    }
  }

  // Function to update welcome message
  function updateWelcomeMessage(userName) {
    const welcomeMessage = document.getElementById('welcomeMessage');
    const currentHour = new Date().getHours();
    let greeting = 'Ch√†o b·∫°n';
    
    if (currentHour < 12) {
      greeting = 'Ch√†o bu·ªïi s√°ng';
    } else if (currentHour < 18) {
      greeting = 'Ch√†o bu·ªïi chi·ªÅu';
    } else {
      greeting = 'Ch√†o bu·ªïi t·ªëi';
    }
    
    welcomeMessage.textContent = `${greeting}, ${userName}!`;
  }

  // Function to handle navigation clicks
  function handleNavClick(section) {
    // Check if user has work schedule
    if (!hasWorkSchedule) {
      // Show no work schedule message for any navigation attempt
      showNoWorkScheduleMessage();
      return;
    }

    // If has work schedule, proceed with normal navigation
    switch(section) {
      case 'dashboard':
        showDashboard();
        break;
      case 'orders':
        showOrders();
        break;
      case 'reports':
        showReports();
        break;
    }
  }

  // Function to load work schedule from API
  async function loadWorkSchedule() {
    try {
      const data = await apiFetch('/shifts/my-work-schedule/today', {
        method: 'GET',
      });
      
      if (data.code === 1000 && data.result) {
        currentWorkSchedule = data.result;
        hasWorkSchedule = true;
        displayWorkSchedule(data.result);
        showDashboard();
      } else {
        throw new Error(data.message || 'Invalid response format');
      }
    } catch (error) {
      console.error('Error loading work schedule:', error);
      handleWorkScheduleError(error);
    }
  }

  // Function to handle work schedule errors
  function handleWorkScheduleError(error) {
    hasWorkSchedule = false;
    
    // Check if error message contains work schedule not found
    const errorMessage = error.message || '';
    
    if (errorMessage.includes('Work schedule not found') || 
        errorMessage.includes('1041') ||
        errorMessage.includes('404')) {
      showNoWorkScheduleMessage();
    } else {
      showError(errorMessage);
    }
  }

  // Function to show no work schedule message
  function showNoWorkScheduleMessage() {
    document.getElementById('dashboardContent').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('noWorkScheduleMessage').style.display = 'block';
    document.getElementById('dynamicContent').style.display = 'none';
    
    // Update page title based on current attempted navigation
    document.getElementById('pageTitle').textContent = 'Th√¥ng b√°o - Kh√¥ng c√≥ ca l√†m vi·ªác';
    
    // Ensure user name is displayed even without work schedule
    if (currentUserInfo) {
      document.getElementById('chefName').textContent = currentUserInfo.username || 'Chef';
    }

    // Update active nav state
    updateActiveNav('dashboard');
  }

  // Function to update active navigation
  function updateActiveNav(section) {
    document.querySelectorAll('.nav-link').forEach(link => {
      link.classList.remove('active');
    });
    
    // Find and activate the correct nav item
    const navItems = {
      'dashboard': '[onclick="handleNavClick(\'dashboard\')"]',
      'orders': '[onclick="handleNavClick(\'orders\')"]',
      'tables': '[onclick="handleNavClick(\'tables\')"]',
      'reports': '[onclick="handleNavClick(\'reports\')"]'
    };
    
    if (navItems[section]) {
      const activeNav = document.querySelector(navItems[section]);
      if (activeNav) {
        activeNav.classList.add('active');
      }
    }
  }

  // Function to contact manager
  function contactManager() {
    alert('Vui l√≤ng li√™n h·ªá v·ªõi qu·∫£n l√Ω qua:\n\n' +
          'üìû Hotline: 1900-xxxx\n' +
          'üìß Email: manager@foodhub.com\n' +
          'üí¨ Ho·∫∑c li√™n h·ªá tr·ª±c ti·∫øp t·∫°i qu·∫ßy l·ªÖ t√¢n');
  }

  // Function to display work schedule data
  function displayWorkSchedule(schedule) {
    // Update welcome message with user name if available
    if (currentUserInfo) {
      updateWelcomeMessage(currentUserInfo.username || 'Chef');
    }
    
    // Update shift information
    document.getElementById('shiftDate').innerHTML = 
        `<i class="fas fa-calendar me-2"></i>Ng√†y: ${schedule.date}`;
    
    // Use startTime and endTime directly
    const startTime = schedule.startTime || 'ƒêang c·∫≠p nh·∫≠t';
    const endTime = schedule.endTime || 'ƒêang c·∫≠p nh·∫≠t';
    document.getElementById('shiftTime').innerHTML = 
        `<i class="fas fa-clock me-2"></i>Ca l√†m: ${startTime} - ${endTime}`;
    
    // Update shift type with appropriate icon
    const shiftTypeText = getShiftTypeText(schedule.shift);
    const shiftIcon = getShiftIcon(schedule.shift);
    document.getElementById('shiftType').innerHTML = 
        `<i class="fas fa-${shiftIcon} me-2"></i>Lo·∫°i ca: ${shiftTypeText}`;
  }

  // Function to get shift type text in Vietnamese
  function getShiftTypeText(shift) {
    const shiftTypes = {
      'MORNING': 'Ca s√°ng',
      'AFTERNOON': 'Ca chi·ªÅu', 
      'EVENING': 'Ca t·ªëi',
      'NIGHT': 'Ca ƒë√™m'
    };
    return shiftTypes[shift] || shift;
  }

  // Function to get appropriate icon for shift type
  function getShiftIcon(shift) {
    const shiftIcons = {
      'MORNING': 'sun',
      'AFTERNOON': 'sun', 
      'EVENING': 'moon',
      'NIGHT': 'moon'
    };
    return shiftIcons[shift] || 'clock';
  }

  // Function to show error message
  function showError(errorText) {
    document.getElementById('dashboardContent').style.display = 'none';
    document.getElementById('noWorkScheduleMessage').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'block';
    document.getElementById('dynamicContent').style.display = 'none';
    document.getElementById('errorText').textContent = errorText;
    
    // Update page title
    document.getElementById('pageTitle').textContent = 'L·ªói - Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu';
  }

  // Existing functions updated to check work schedule
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');

    sidebar.classList.toggle('collapsed');

    if (mainContent) {
      mainContent.classList.toggle('expanded');
    }

    window.sidebarCollapsed = sidebar.classList.contains('collapsed');
  }

  function setActiveNav(element) {
    document.querySelectorAll('.nav-link').forEach(link => {
      link.classList.remove('active');
    });
    element.classList.add('active');
  }

  function handleLogout() {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën k·∫øt th√∫c ca l√†m vi·ªác?')) {
      document.body.style.opacity = '0.5';
      document.body.style.transition = 'opacity 0.5s';

      setTimeout(() => {
        alert('ƒê√£ k·∫øt th√∫c ca l√†m vi·ªác! C·∫£m ∆°n b·∫°n ƒë√£ l√†m vi·ªác chƒÉm ch·ªâ.');
        document.body.style.opacity = '1';
        // Clear saved data
        currentUserInfo = null;
        currentWorkSchedule = null;
        // Redirect to login or home page
        // window.location.href = '/login';
      }, 1000);
    }
  }

  function showDashboard() {
    if (!hasWorkSchedule) {
        showNoWorkScheduleMessage();
        return;
    }
    
    // Update page title
    document.getElementById('pageTitle').textContent = 'Dashboard - Ca L√†m Vi·ªác';
    
    // Show dashboard content and hide others
    document.getElementById('dashboardContent').style.display = 'block';
    document.getElementById('dynamicContent').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('noWorkScheduleMessage').style.display = 'none';

    // Update active navigation
    updateActiveNav('dashboard');
}


  // Placeholder functions for other navigation items
  function showOrders() {
    if (!hasWorkSchedule) {
      showNoWorkScheduleMessage();
      return;
    }
    // Implementation for orders view
    console.log('Show orders');
    updateActiveNav('orders');
  }

  function showTables() {
    if (!hasWorkSchedule) {
      showNoWorkScheduleMessage();
      return;
    }
    // Implementation for tables view
    console.log('Show tables');
    updateActiveNav('tables');
  }

  function showReports() {
    if (!hasWorkSchedule) {
      showNoWorkScheduleMessage();
      return;
    }
    // Implementation for reports view
    console.log('Show reports');
    updateActiveNav('reports');
  }
</script>
<script src="js/order.js"></script>
<script src="js/report.js"></script>
<script src="../js/fetch-api.js"></script>
</body>
</html>