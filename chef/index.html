<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chef Dashboard - Kitchen Management</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&family=Pacifico&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar d-flex flex-column" id="sidebar">
    <div class="brand">
      <h3>
        <i class="fa fa-utensils"></i>
        <span class="brand-text">FoodHub</span>
      </h3>
      <small>Kitchen Panel </small>
    </div>

    <nav class="sidebar-nav flex-fill">
      <ul class="nav flex-column">
        <li class="nav-item">
          <a href="#" class="nav-link active" onclick="handleNavClick('dashboard')">
            <i class="fas fa-tachometer-alt"></i>
            <span class="nav-text">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" onclick="handleNavClick('orders')">
            <i class="fas fa-clipboard-list"></i>
            <span class="nav-text">ƒê∆°n H√†ng</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" onclick="handleNavClick('tables')">
            <i class="fas fa-chair"></i>
            <span class="nav-text">H√†ng ƒê·ª£i</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" onclick="handleNavClick('reports')">
            <i class="fas fa-chart-line"></i>
            <span class="nav-text">B√°o C√°o Ca L√†m</span>
          </a>
        </li>
      </ul>
    </nav>

    <div class="logout-section">
      <button class="logout-btn" onclick="handleLogout()">
        <i class="fas fa-sign-out-alt"></i>
        <span class="btn-text">K·∫øt Th√∫c Ca L√†m</span>
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="d-flex align-items-center">
        <button class="toggle-sidebar me-3" onclick="toggleSidebar()">
          <i class="fas fa-bars"></i>
        </button>
        <h4 class="mb-0" id="pageTitle">Dashboard - Ca L√†m Vi·ªác</h4>
      </div>
      <div class="d-flex align-items-center">
        <div class="notification-bell" onclick="toggleNotificationDropdown()">
          <i class="fas fa-bell"></i>
          <span class="notification-badge" id="notificationCount">0</span>

          <!-- Notification Dropdown -->
          <div class="notification-dropdown" id="notificationDropdown">
            <div class="notification-header">
              <h6>Th√¥ng b√°o</h6>
              <button class="clear-all-btn" onclick="clearAllNotifications()">X√≥a t·∫•t c·∫£</button>
            </div>
            <div class="notification-list" id="notificationList">
              <div class="notification-empty">
                <i class="fas fa-bell-slash"></i>
                <div>Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</div>
              </div>
            </div>
          </div>
        </div>
        <div class="dropdown">
          <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-user-circle me-2"></i><span id="chefName">ƒêang t·∫£i...</span>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>H·ªì S∆°</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-clock me-2"></i>L·ªãch L√†m Vi·ªác</a></li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt me-2"></i>K·∫øt
                Th√∫c Ca</a></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboardContent">
      <!-- Welcome Section -->
      <div class="welcome-section">
        <div class="row align-items-center">
          <div class="col-md-8">
            <p class="mb-2" id="shiftTime"><i class="fas fa-clock me-2"></i>Ca l√†m: ƒêang t·∫£i...</p>
            <p class="mb-2" id="shiftDate"><i class="fas fa-calendar me-2"></i>Ng√†y: ƒêang t·∫£i...</p>
            <p class="mb-0" id="shiftType"><i class="fas fa-sun me-2"></i>Lo·∫°i ca: ƒêang t·∫£i...</p>
          </div>
          <div class="col-md-4 text-center">
            <i class="fas fa-chef-hat" style="font-size: 4rem; color: rgba(255,255,255,0.8);"></i>
          </div>
        </div>
      </div>

      <!-- Stats Section -->
      <div class="stats-section">
        <div class="stat-card">
          <div class="stat-number" id="pendingCount">0</div>
          <div class="stat-label">ƒê∆°n Ch·ªù X·ª≠ L√Ω</div>
          <i class="fas fa-hourglass-half stat-icon"></i>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="preparingCount">0</div>
          <div class="stat-label">ƒêang Ch·∫ø Bi·∫øn</div>
          <i class="fas fa-fire stat-icon"></i>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="readyCount">0</div>
          <div class="stat-label">S·∫µn S√†ng Ph·ª•c V·ª•</div>
          <i class="fas fa-check-circle stat-icon"></i>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="avgTime">15p</div>
          <div class="stat-label">Th·ªùi Gian N·∫•u TB</div>
          <i class="fas fa-stopwatch stat-icon"></i>
        </div>
      </div>

      <div class="orders-recent-section" id="dashboardOrdersSection">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">
            <i class="fas fa-clipboard-list me-2"></i>
            ƒê∆°n h√†ng g·∫ßn ƒë√¢y
          </h5>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-success" onclick="refreshDashboardOrders()">
              <i class="fas fa-sync-alt me-1"></i>
              L√†m m·ªõi
            </button>
            <button class="btn btn-primary" onclick="showOrders()">
              <i class="fas fa-eye me-1"></i>
              Xem t·∫•t c·∫£
            </button>
          </div>
        </div>

        <!-- Orders List -->
        <div class="dashboard-orders-list" id="dashboardOrdersList">
          <!-- Loading state -->
          <div class="dashboard-orders-loading" id="dashboardOrdersLoading">
            <div class="d-flex justify-content-center align-items-center py-4">
              <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <span>ƒêang t·∫£i ƒë∆°n h√†ng...</span>
            </div>
          </div>

          <!-- Orders will be rendered here -->
          <div class="dashboard-orders-content" id="dashboardOrdersContent" style="display: none;">
            <!-- Orders list will be populated by JavaScript -->
          </div>

          <!-- Empty state -->
          <div class="dashboard-orders-empty" id="dashboardOrdersEmpty" style="display: none;">
            <div class="text-center py-4">
              <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
              <h6 class="text-muted">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h6>
              <p class="text-muted small">ƒê∆°n h√†ng m·ªõi s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- No Work Schedule Message -->
    <div id="noWorkScheduleMessage" style="display: none; text-align: center; padding: 50px;">
      <div class="alert alert-warning" role="alert" style="max-width: 600px; margin: 0 auto;">
        <i class="fas fa-calendar-times"
          style="font-size: 3rem; color: #856404; margin-bottom: 1rem; display: block;"></i>
        <h4 class="alert-heading">Kh√¥ng c√≥ ca l√†m vi·ªác h√¥m nay</h4>
        <p class="mb-3">H·ªá th·ªëng kh√¥ng t√¨m th·∫•y l·ªãch l√†m vi·ªác c·ªßa b·∫°n cho ng√†y h√¥m nay. ƒêi·ªÅu n√†y c√≥ th·ªÉ do:</p>
        <ul class="text-start mb-3" style="display: inline-block;">
          <li>B·∫°n kh√¥ng ƒë∆∞·ª£c ph√¢n c√¥ng ca l√†m vi·ªác h√¥m nay</li>
          <li>L·ªãch l√†m vi·ªác ch∆∞a ƒë∆∞·ª£c c·∫≠p nh·∫≠t</li>
          <li>C√≥ l·ªói trong h·ªá th·ªëng ph√¢n c√¥ng</li>
        </ul>
        <hr>
        <div class="d-flex gap-2 justify-content-center">
          <button class="btn btn-outline-primary" onclick="loadWorkSchedule()">
            <i class="fas fa-refresh me-2"></i>Th·ª≠ l·∫°i
          </button>
          <button class="btn btn-primary" onclick="contactManager()">
            <i class="fas fa-phone me-2"></i>Li√™n h·ªá qu·∫£n l√Ω
          </button>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" style="display: none; text-align: center; padding: 50px;">
      <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i>
      <h4>Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ca l√†m vi·ªác</h4>
      <p id="errorText">ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</p>
      <button class="btn btn-primary" onclick="loadWorkSchedule()">
        <i class="fas fa-refresh me-2"></i>Th·ª≠ l·∫°i
      </button>
    </div>

    <!-- Dynamic Content Area -->
    <div id="dynamicContent" style="display: none;">
      <!-- Content will be loaded here dynamically -->
    </div>
  </div>




  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script>
    // Global variables to store data
    let currentWorkSchedule = null;
    let currentUserInfo = null;
    let hasWorkSchedule = false;
    let audioContext = null;
    let notifications = [];
    let notificationDropdownOpen = false;
    // 2. Th√™m h√†m kh·ªüi t·∫°o AudioContext sau user gesture
    function initializeAudioContext() {
      if (!audioContext) {
        try {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          console.log('AudioContext initialized successfully');
        } catch (error) {
          console.error('Failed to initialize AudioContext:', error);
        }
      }
      console.log("AudioContext has been initialized successfully")
    }
    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function () {
      // Kh·ªüi t·∫°o AudioContext khi user click l·∫ßn ƒë·∫ßu ti√™n
      const enableAudio = () => {
        initializeAudioContext();
        // Remove listener sau khi ƒë√£ kh·ªüi t·∫°o
        document.removeEventListener('click', enableAudio);
        document.removeEventListener('keydown', enableAudio);
        document.removeEventListener('touchstart', enableAudio);
      };

      document.addEventListener('click', enableAudio);
      document.addEventListener('keydown', enableAudio);
      document.addEventListener('touchstart', enableAudio);

      // Load existing functions
      updateNotificationCount();
      loadUserInfo();
      loadWorkSchedule();

    });

    // Function to load user information from API
    async function loadUserInfo() {
      try {
        const data = await apiFetch('/users/my-info', {
          method: 'GET',
        });

        if (data.code === 0 && data.result) {
          currentUserInfo = data.result;
          displayUserInfo(data.result);


        } else {
          console.error('Error loading user info:', data.message);
          document.getElementById('chefName').textContent = 'Chef';
        }
      } catch (error) {
        console.error('Error loading user info:', error);
        document.getElementById('chefName').textContent = 'Nh√¢n vi√™n';
      }
    }

    function initializeWebSocket(userInfo) {
      console.log('Initializing WebSocket for role:', currentWorkSchedule.role);

      // K·∫øt n·ªëi WebSocket
      connectWebSocket(currentWorkSchedule, handleWebSocketMessage);
    }

    // Function to display user information
    function displayUserInfo(userInfo) {
      // Extract username for display
      const displayName = userInfo.username || 'Nh√¢n vi√™n';

      // Update chef name in header
      document.getElementById('chefName').textContent = displayName;
    }


    // Function to handle navigation clicks
    function handleNavClick(section) {
      // Check if user has work schedule
      if (!hasWorkSchedule) {
        // Show no work schedule message for any navigation attempt
        showNoWorkScheduleMessage();
        return;
      }

      // If has work schedule, proceed with normal navigation
      switch (section) {
        case 'dashboard':
          showDashboard();
          break;
        case 'orders':
          showOrders();
          break;
        case 'reports':
          showReports();
          break;
      }
    }

    // Function to load work schedule from API
    async function loadWorkSchedule() {
      try {
        const data = await apiFetch('/shifts/my-work-schedule/today', {
          method: 'GET',
        });

        if (data.code === 1000 && data.result) {
          currentWorkSchedule = data.result;
          hasWorkSchedule = true;
          displayWorkSchedule(data.result);
          showDashboard();
          initializeWebSocket(currentWorkSchedule);
        } else {
          throw new Error(data.message || 'Invalid response format');
        }
        if (document.getElementById('dashboardOrdersSection')) {
          console.log('init order');
          initDashboardOrders();
        }
      } catch (error) {
        console.error('Error loading work schedule:', error);
        handleWorkScheduleError(error);
      }
    }

    // Function to handle work schedule errors
    function handleWorkScheduleError(error) {
      hasWorkSchedule = false;

      // Check if error message contains work schedule not found
      const errorMessage = error.message || '';

      if (errorMessage.includes('Work schedule not found') ||
        errorMessage.includes('1041') ||
        errorMessage.includes('404')) {
        showNoWorkScheduleMessage();
      } else {
        showError(errorMessage);
      }
    }

    // Function to show no work schedule message
    function showNoWorkScheduleMessage() {
      document.getElementById('dashboardContent').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('noWorkScheduleMessage').style.display = 'block';
      document.getElementById('dynamicContent').style.display = 'none';

      // Update page title based on current attempted navigation
      document.getElementById('pageTitle').textContent = 'Th√¥ng b√°o - Kh√¥ng c√≥ ca l√†m vi·ªác';

      // Ensure user name is displayed even without work schedule
      if (currentUserInfo) {
        document.getElementById('chefName').textContent = currentUserInfo.username || 'Chef';
      }

      // Update active nav state
      updateActiveNav('dashboard');
    }

    // Function to update active navigation
    function updateActiveNav(section) {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });

      // Find and activate the correct nav item
      const navItems = {
        'dashboard': '[onclick="handleNavClick(\'dashboard\')"]',
        'orders': '[onclick="handleNavClick(\'orders\')"]',
        'tables': '[onclick="handleNavClick(\'tables\')"]',
        'reports': '[onclick="handleNavClick(\'reports\')"]'
      };

      if (navItems[section]) {
        const activeNav = document.querySelector(navItems[section]);
        if (activeNav) {
          activeNav.classList.add('active');
        }
      }
    }

    // Function to contact manager
    function contactManager() {
      alert('Vui l√≤ng li√™n h·ªá v·ªõi qu·∫£n l√Ω qua:\n\n' +
        'üìû Hotline: 1900-xxxx\n' +
        'üìß Email: manager@foodhub.com\n' +
        'üí¨ Ho·∫∑c li√™n h·ªá tr·ª±c ti·∫øp t·∫°i qu·∫ßy l·ªÖ t√¢n');
    }

    // Function to display work schedule data
    function displayWorkSchedule(schedule) {
      // Parse and format date
      const scheduleDate = new Date(schedule.date);
      const formattedDate = scheduleDate.toLocaleDateString('vi-VN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });

      // Update shift information
      document.getElementById('shiftDate').innerHTML =
        `<i class="fas fa-calendar me-2"></i>Ng√†y: ${formattedDate}`;

      // Parse and format time
      const startTime = new Date(schedule.startTime);
      const endTime = new Date(schedule.endTime);

      const formattedStartTime = startTime.toLocaleTimeString('vi-VN', {
        hour: '2-digit',
        minute: '2-digit'
      });

      const formattedEndTime = endTime.toLocaleTimeString('vi-VN', {
        hour: '2-digit',
        minute: '2-digit'
      });

      document.getElementById('shiftTime').innerHTML =
        `<i class="fas fa-clock me-2"></i>Ca l√†m: ${formattedStartTime} - ${formattedEndTime}`;

      // Update shift type with appropriate icon
      const shiftTypeText = getShiftTypeText(schedule.shift);
      const shiftIcon = getShiftIcon(schedule.shift);
      document.getElementById('shiftType').innerHTML =
        `<i class="fas fa-${shiftIcon} me-2"></i>Lo·∫°i ca: ${shiftTypeText}`;

    }



    // Function to get shift type text in Vietnamese
    function getShiftTypeText(shift) {
      const shiftTypes = {
        'MORNING': 'Ca s√°ng',
        'AFTERNOON': 'Ca chi·ªÅu',
        'EVENING': 'Ca t·ªëi',
        'NIGHT': 'Ca ƒë√™m'
      };
      return shiftTypes[shift] || shift;
    }

    // Function to get appropriate icon for shift type
    function getShiftIcon(shift) {
      const shiftIcons = {
        'MORNING': 'sun',
        'AFTERNOON': 'sun',
        'EVENING': 'moon',
        'NIGHT': 'moon'
      };
      return shiftIcons[shift] || 'clock';
    }

    // Function to show error message
    function showError(errorText) {
      document.getElementById('dashboardContent').style.display = 'none';
      document.getElementById('noWorkScheduleMessage').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('dynamicContent').style.display = 'none';
      document.getElementById('errorText').textContent = errorText;

      // Update page title
      document.getElementById('pageTitle').textContent = 'L·ªói - Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu';
    }

    // Existing functions updated to check work schedule
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');

      sidebar.classList.toggle('collapsed');

      if (mainContent) {
        mainContent.classList.toggle('expanded');
      }

      window.sidebarCollapsed = sidebar.classList.contains('collapsed');
    }

    function setActiveNav(element) {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });
      element.classList.add('active');
    }

    function handleLogout() {
      if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën k·∫øt th√∫c ca l√†m vi·ªác?')) {
        document.body.style.opacity = '0.5';
        document.body.style.transition = 'opacity 0.5s';

        setTimeout(() => {
          alert('ƒê√£ k·∫øt th√∫c ca l√†m vi·ªác! C·∫£m ∆°n b·∫°n ƒë√£ l√†m vi·ªác chƒÉm ch·ªâ.');
          document.body.style.opacity = '1';
          // Clear saved data
          currentUserInfo = null;
          currentWorkSchedule = null;
          // Redirect to login or home page
          // window.location.href = '/login';
        }, 1000);
      }
    }

    function showDashboard() {
      if (!hasWorkSchedule) {
        showNoWorkScheduleMessage();
        return;
      }

      // Update page title
      document.getElementById('pageTitle').textContent = 'Dashboard - Ca L√†m Vi·ªác';

      // Show dashboard content and hide others
      document.getElementById('dashboardContent').style.display = 'block';
      document.getElementById('dynamicContent').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('noWorkScheduleMessage').style.display = 'none';

      // Update active navigation
      updateActiveNav('dashboard');
    }



    // Placeholder functions for other navigation items
    function showOrders() {
      if (!hasWorkSchedule) {
        showNoWorkScheduleMessage();
        return;
      }
      // Implementation for orders view
      console.log('Show orders');
      updateActiveNav('orders');
    }

    function showTables() {
      if (!hasWorkSchedule) {
        showNoWorkScheduleMessage();
        return;
      }
      // Implementation for tables view
      console.log('Show tables');
      updateActiveNav('tables');
    }

    function showReports() {
      if (!hasWorkSchedule) {
        showNoWorkScheduleMessage();
        return;
      }
      // Implementation for reports view
      console.log('Show reports');
      updateActiveNav('reports');
    }

    // WebSocket notification handling
    // H√†m x·ª≠ l√Ω WebSocket message v·ªõi th√¥ng b√°o c√≥ √¢m thanh
    function handleWebSocketMessage(data) {
      console.log('Received notification:', data);
      console.log('üì© data.message:', data.message);
      console.log('data.type:', data.type);

      // Add to notification list
      addNotificationToList(data.message, data.type || 'order');

      // Show WebSocket notification popup
      showWebSocketNotification(data.message);

      // Update dashboard stats if needed
      if (hasWorkSchedule) {
        updateDashboardStats();
      }
    }

    // H√†m hi·ªÉn th·ªã th√¥ng b√°o WebSocket v·ªõi √¢m thanh v√† hi·ªáu ·ª©ng ƒë·∫∑c bi·ªát
    function showWebSocketNotification(message) {
      console.log("WebSocket notification: ", message);

      // Ph√°t √¢m thanh th√¥ng b√°o (c√≥ th·ªÉ thay ƒë·ªïi lo·∫°i √¢m thanh)
      playNotificationSound(); // C√≥ th·ªÉ thay ƒë·ªïi th√†nh: 'bell', 'chime', 'ping', 'success', 'gentle'

      // T·∫°o notification element
      const notification = document.createElement('div');
      notification.className = 'websocket-notification';
      notification.innerHTML = `
        <div class="websocket-notification-content">
            <span>${message}</span>
            <button class="close-btn" onclick="closeWebSocketNotification(this)">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;

      // Th√™m v√†o body
      document.body.appendChild(notification);

      // Hi·ªán notification v·ªõi animation
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);

      // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
      setTimeout(() => {
        closeWebSocketNotification(notification);
      }, 5000);
    }

    // H√†m ƒë√≥ng th√¥ng b√°o WebSocket
    function closeWebSocketNotification(element) {
      const notification = element.tagName === 'BUTTON' ? element.closest('.websocket-notification') : element;

      notification.classList.remove('show');
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }

    // H√†m ph√°t √¢m thanh th√¥ng b√°o
    function playNotificationSound() {
      // Ki·ªÉm tra n·∫øu AudioContext ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o
      if (!audioContext) {
        console.log('AudioContext ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o');
        return;
      }

      try {
        // Resume AudioContext n·∫øu b·ªã suspended
        if (audioContext.state === 'suspended') {
          audioContext.resume().then(() => {
            playChimeSound();
          }).catch(error => {
            console.log('Kh√¥ng th·ªÉ resume AudioContext:', error);
          });
        } else {
          playChimeSound();
        }
      } catch (error) {
        console.log('Kh√¥ng th·ªÉ ph√°t √¢m thanh th√¥ng b√°o:', error);
      }
    }



    function playChimeSound() {
      if (!audioContext || audioContext.state === 'closed') {
        console.log('AudioContext kh√¥ng kh·∫£ d·ª•ng');
        return;
      }

      const frequencies = [523, 659, 784]; // C, E, G

      frequencies.forEach((freq, index) => {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
        oscillator.type = 'sine';

        const startTime = audioContext.currentTime + (index * 0.15);
        gainNode.gain.setValueAtTime(0.2, startTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 1);

        oscillator.start(startTime);
        oscillator.stop(startTime + 1);
      });
    }

    // Function to update notification count
    function updateNotificationCount() {
      const notificationBadge = document.getElementById('notificationCount');
      const unreadCount = notifications.filter(n => !n.read).length;

      notificationBadge.textContent = unreadCount;
      notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';

      if (unreadCount > 0) {
        notificationBadge.classList.add('notification-pulse');
        setTimeout(() => {
          notificationBadge.classList.remove('notification-pulse');
        }, 1000);
      }
    }

    // Function to update dashboard stats (placeholder)
    function updateDashboardStats() {
      // Reload dashboard data or update specific stats
      // This is a placeholder - implement based on your actual API
      const pendingElement = document.getElementById('pendingCount');
      if (pendingElement) {
        let currentCount = parseInt(pendingElement.textContent) || 0;
        pendingElement.textContent = currentCount + 1;
      }
    }

    function showNotification(message, type = 'info') {
      // T·∫°o notification element
      console.log("notification: ", message);
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.innerHTML = `
        <div class="notification-content">
            <i class="fas ${getNotificationIcon(type)}"></i>
            <span>${message}</span>
        </div>
    `;

      // Th√™m v√†o body
      document.body.appendChild(notification);

      // Hi·ªán notification
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);

      // T·ª± ƒë·ªông ·∫©n sau 3 gi√¢y
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    function toggleNotificationDropdown() {
      const dropdown = document.getElementById('notificationDropdown');
      const isVisible = dropdown.classList.contains('show');
      console.log("in toggleNotificationDropdown");
      if (isVisible) {
        hideNotificationDropdown();
      } else {
        showNotificationDropdown();
      }
    }

    // Function to show notification dropdown
    function showNotificationDropdown() {
      const dropdown = document.getElementById('notificationDropdown');
      dropdown.classList.add('show');
      notificationDropdownOpen = true;

      // Mark all notifications as read
      markAllNotificationsAsRead();

      // Close dropdown when clicking outside
      setTimeout(() => {
        document.addEventListener('click', handleOutsideClick);
      }, 100);
    }

    function hideNotificationDropdown() {
      const dropdown = document.getElementById('notificationDropdown');
      dropdown.classList.remove('show');
      notificationDropdownOpen = false;

      document.removeEventListener('click', handleOutsideClick);
    }

    // Function to handle clicking outside dropdown
    function handleOutsideClick(event) {
      const dropdown = document.getElementById('notificationDropdown');
      const bell = document.querySelector('.notification-bell');

      if (!dropdown.contains(event.target) && !bell.contains(event.target)) {
        hideNotificationDropdown();
      }
    }


    function addNotificationToList(message, type = 'order') {
      const notification = {
        id: Date.now(),
        message: message,
        type: type,
        timestamp: new Date(),
        read: false
      };

      // Add to beginning of array
      notifications.unshift(notification);

      // Keep only last 50 notifications
      if (notifications.length > 50) {
        notifications = notifications.slice(0, 50);
      }

      // Update UI
      updateNotificationsList();
      updateNotificationCount();
    }

    // Function to update notifications list display
    function updateNotificationsList() {
      const listContainer = document.getElementById('notificationList');

      if (notifications.length === 0) {
        listContainer.innerHTML = `
      <div class="notification-empty">
        <i class="fas fa-bell-slash"></i>
        <div>Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</div>
      </div>
    `;
        return;
      }

      const notificationsHTML = notifications.map(notification => {
        const timeAgo = getTimeAgo(notification.timestamp);
        const typeIcon = getNotificationTypeIcon(notification.type);

        return `
      <div class="notification-item ${!notification.read ? 'unread' : ''}" 
           onclick="markNotificationAsRead(${notification.id})">
        <div class="d-flex align-items-start">
          <div class="notification-type-icon notification-type-${notification.type}">
            <i class="fas ${typeIcon}"></i>
          </div>
          <div class="notification-content flex-grow-1">
            <div class="notification-message">${notification.message}</div>
            <div class="notification-time">${timeAgo}</div>
          </div>
        </div>
      </div>
    `;
      }).join('');

      listContainer.innerHTML = notificationsHTML;
    }

    // Function to get notification type icon
    function getNotificationTypeIcon(type) {
      const icons = {
        'order': 'fa-utensils',
        'system': 'fa-info-circle',
        'alert': 'fa-exclamation-triangle',
        'success': 'fa-check-circle'
      };
      return icons[type] || 'fa-bell';
    }

    // Function to get time ago string
    function getTimeAgo(timestamp) {
      const now = new Date();
      const diffInSeconds = Math.floor((now - timestamp) / 1000);

      if (diffInSeconds < 60) {
        return 'V·ª´a xong';
      } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes} ph√∫t tr∆∞·ªõc`;
      } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours} gi·ªù tr∆∞·ªõc`;
      } else {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days} ng√†y tr∆∞·ªõc`;
      }
    }

    // Function to mark notification as read
    function markNotificationAsRead(notificationId) {
      const notification = notifications.find(n => n.id === notificationId);
      if (notification) {
        notification.read = true;
        updateNotificationsList();
        updateNotificationCount();
      }
    }

    // Function to mark all notifications as read
    function markAllNotificationsAsRead() {
      notifications.forEach(notification => {
        notification.read = true;
      });
      updateNotificationsList();
      updateNotificationCount();
    }

    // Function to clear all notifications
    function clearAllNotifications() {
      if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ th√¥ng b√°o?')) {
        notifications = [];
        updateNotificationsList();
        updateNotificationCount();
      }
    }

    function initDashboardOrders() {
      loadDashboardOrders();
    }


    // Load orders for dashboard (recent orders only)
    async function loadDashboardOrders() {
      try {
        showDashboardLoading();

        // Build query parameters for recent orders
        const params = new URLSearchParams();
        params.append('page', '0');
        params.append('size', '10'); // Only show 10 recent orders
        params.append('orderBy', 'createdAt');
        params.append('sort', 'DESC');

        if (currentWorkSchedule && currentWorkSchedule.startTime) {
          params.append('startTime', currentWorkSchedule.startTime);
        }

        // Fetch orders
        const data = await apiFetch(`/orders/chef/work-shift-orders?${params.toString()}`, {
          method: 'GET'
        });

        const orderPage = data.result;
        const orders = orderPage.content || [];

        // Update dashboard with orders
        renderDashboardOrders(orders);

        // THAY ƒê·ªîI: Truy·ªÅn orders v√†o updateDashboardStats
        updateDashboardStats(orders);

        // TH√äM: Ho·∫∑c c√≥ th·ªÉ load full stats n·∫øu mu·ªën ƒë·ªô ch√≠nh x√°c cao h∆°n
        // await loadFullOrdersStats();

      } catch (error) {
        console.error('Error loading dashboard orders:', error);
        showDashboardError(error.message);
      }
    }



    // Render orders in dashboard
    function renderDashboardOrders(orders) {
      const loadingElement = document.getElementById('dashboardOrdersLoading');
      const contentElement = document.getElementById('dashboardOrdersContent');
      const emptyElement = document.getElementById('dashboardOrdersEmpty');

      // Hide loading
      if (loadingElement) {
        loadingElement.style.display = 'none';
      }

      if (orders.length === 0) {
        // Show empty state
        if (contentElement) {
          contentElement.style.display = 'none';
        }
        if (emptyElement) {
          emptyElement.style.display = 'block';
        }
        return;
      }

      // Show content
      if (emptyElement) {
        emptyElement.style.display = 'none';
      }
      if (contentElement) {
        contentElement.style.display = 'block';

        // Render orders
        contentElement.innerHTML = orders.map(order => `
            <div class="dashboard-order-item ${order.status.toLowerCase()}" 
                 onclick="viewOrderDetails(${order.id})">
                <div class="order-header">
                    <span class="order-id">#${order.id}</span>
                    <span class="order-time">
                        <i class="fas fa-clock me-1"></i>
                        ${formatDateTime(order.createdAt)}
                    </span>
                </div>
                <div class="order-info">
                    <div class="order-details">
                        <span class="table-number-badge">
                            <i class="fas fa-chair me-1"></i>
                            ${order.tableNumber ? `B√†n ${order.tableNumber}` : 'Mang v·ªÅ'}
                        </span>
                        <span class="order-amount">
                            <i class="fas fa-money-bill me-1"></i>
                            ${formatCurrency(order.totalAmount)}
                        </span>
                    </div>
                    <span class="status-badge status-${order.status.toLowerCase()}">
                        ${statusTranslations[order.status] || order.status}
                    </span>
                </div>
            </div>
        `).join('');
      }
    }

    function showDashboardLoading() {
      const loadingElement = document.getElementById('dashboardOrdersLoading');
      const contentElement = document.getElementById('dashboardOrdersContent');
      const emptyElement = document.getElementById('dashboardOrdersEmpty');

      if (loadingElement) {
        loadingElement.style.display = 'block';
      }
      if (contentElement) {
        contentElement.style.display = 'none';
      }
      if (emptyElement) {
        emptyElement.style.display = 'none';
      }
    }

    // Show error state
    function showDashboardError(message) {
      const loadingElement = document.getElementById('dashboardOrdersLoading');
      const contentElement = document.getElementById('dashboardOrdersContent');
      const emptyElement = document.getElementById('dashboardOrdersEmpty');

      if (loadingElement) {
        loadingElement.style.display = 'none';
      }
      if (contentElement) {
        contentElement.style.display = 'none';
      }
      if (emptyElement) {
        emptyElement.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <h6 class="text-danger">L·ªói t·∫£i ƒë∆°n h√†ng</h6>
                <p class="text-muted small">${message}</p>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshDashboardOrders()">
                    <i class="fas fa-sync-alt me-1"></i>
                    Th·ª≠ l·∫°i
                </button>
            </div>
        `;
        emptyElement.style.display = 'block';
      }
    }

    // Refresh dashboard orders manually
    function refreshDashboardOrders() {
      loadDashboardOrders();
    }

    function formatDateTime(dateString) {
      // Parse the date string as UTC to avoid timezone conversion
      const date = new Date(dateString);
      const now = new Date();

      // Calculate difference using UTC time to avoid timezone issues
      const diffMs = now.getTime() - date.getTime();
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      // Format time part - no timezone conversion needed since dateString is already Vietnam time
      const timeStr = date.toLocaleTimeString('vi-VN', {
        hour: '2-digit',
        minute: '2-digit',
        timeZone: 'UTC' // Treat as UTC to prevent double timezone conversion
      });

      if (diffMins < 1) {
        return 'V·ª´a xong';
      } else if (diffMins < 60) {
        return `${diffMins} ph√∫t tr∆∞·ªõc`;
      } else if (diffHours < 24) {
        return `${diffHours} gi·ªù tr∆∞·ªõc (${timeStr})`;
      } else if (diffDays < 7) {
        return `${diffDays} ng√†y tr∆∞·ªõc (${timeStr})`;
      } else {
        return date.toLocaleDateString('vi-VN', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          timeZone: 'UTC' // Treat as UTC to prevent double timezone conversion
        }) + ` ${timeStr}`;
      }
    }
    // Disconnect WebSocket when page unloads
    window.addEventListener('beforeunload', function () {
      disconnectWebSocket();

      // Cleanup AudioContext
      if (audioContext && audioContext.state !== 'closed') {
        audioContext.close();
      }
    });
  </script>
  <script src="js/order.js"></script>
  <script src="js/report.js"></script>
  <script src="../js/fetch-api.js"></script>
  <script src="../js/websocket.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</body>

</html>