<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Danh sách món ăn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-available {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-unavailable {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .action-buttons {
            white-space: nowrap;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .menu-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }
        .price-text {
            font-weight: 600;
            color: #28a745;
        }
        @media (max-width: 768px) {
            .container-fluid {
                padding: 0 15px;
            }
            .table-responsive {
                font-size: 0.9rem;
            }
            .menu-image {
                width: 40px;
                height: 40px;
            }
            .action-buttons .btn-sm {
                padding: 0.125rem 0.25rem;
                font-size: 0.75rem;
            }
        }
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .notification-enter {
            animation: slideInRight 0.3s ease-out;
        }
        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.075);
        }
        .btn:hover {
            transform: translateY(-1px);
            transition: transform 0.2s ease;
        }
        .table-responsive::-webkit-scrollbar {
            height: 6px;
        }
        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .table-responsive::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-utensils me-2"></i>Danh sách món ăn</h1>
                <a href="/foodhub/menu-manager/add-dish.html" class="btn btn-success">
                    <i class="fas fa-plus me-1"></i>Tạo món ăn
                </a>
            </div>

            <!-- Bộ lọc -->
            <div class="card mb-4">
                <div class="card-body">
                    <form id="filterForm" class="row g-3">
                        <div class="col-md-3">
                            <label for="categoryId" class="form-label">Danh mục</label>
                            <select id="categoryId" class="form-select">
                                <option value="">Tất cả danh mục</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="sortBy" class="form-label">Sắp xếp theo</label>
                            <select id="sortBy" class="form-select">
                                <option value="">Mặc định</option>
                                <option value="price_asc">Giá tăng dần</option>
                                <option value="price_desc">Giá giảm dần</option>
                                <option value="name_asc">Tên A-Z</option>
                                <option value="name_desc">Tên Z-A</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="keyword" class="form-label">Tìm kiếm</label>
                            <input type="text" id="keyword" class="form-control" placeholder="Nhập tên món ăn...">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-filter me-1"></i>Lọc
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Bảng danh sách món ăn -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                            <tr>
                                <th style="width: 80px;">Hình ảnh</th>
                                <th>Tên món ăn</th>
                                <th>Mô tả</th>
                                <th style="width: 120px;">Giá</th>
                                <th>Danh mục</th>
                                <th style="width: 120px;">Trạng thái</th>
                                <th style="width: 150px;">Thao tác</th>
                            </tr>
                            </thead>
                            <tbody id="menuTableBody">
                            <!-- Dữ liệu sẽ được load ở đây -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Loading spinner -->
                    <div id="loadingSpinner" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                    </div>

                    <!-- Empty state -->
                    <div id="emptyState" class="text-center py-5" style="display: none;">
                        <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Không có món ăn nào</h5>
                        <p class="text-muted">Thử thay đổi bộ lọc để xem thêm món ăn</p>
                    </div>
                </div>
            </div>

            <!-- Phân trang -->
            <nav class="mt-4">
                <ul class="pagination justify-content-center" id="pagination"></ul>
            </nav>
        </div>
    </div>
</div>

<script>
    const apiMenuUrl = '/foodhub/menu-items';
    const apiCategoryUrl = '/foodhub/categories';
    let currentPage = 0;
    const pageSize = 10;

    // Lấy danh mục
    function fetchCategories() {
        axios.get(apiCategoryUrl)
            .then(res => {
                const select = document.getElementById('categoryId');
                res.data.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Lỗi khi tải danh mục:', error);
            });
    }

    // Lấy danh sách món ăn
    function fetchMenuItems() {
        showLoading();

        const categoryId = document.getElementById('categoryId').value;
        const sortValue = document.getElementById('sortBy').value;
        const keyword = document.getElementById('keyword').value.trim();

        let sortBy = null;
        let sortDirection = 'asc';
        if (sortValue) {
            const parts = sortValue.split('_');
            sortBy = parts[0];
            sortDirection = parts[1] || 'asc';
        }

        const params = {
            page: currentPage,
            size: pageSize
        };

        if (categoryId) {
            params.categoryId = categoryId;
        }

        if (sortBy) {
            params.sortBy = sortBy;
            params.sortDirection = sortDirection;
        }

        if (keyword) {
            params.keyword = keyword;
        }

        axios.get(apiMenuUrl, { params })
            .then(response => {
                hideLoading();
                renderMenuTable(response.data.content);
                renderPagination(response.data.totalPages, response.data.number);
            })
            .catch(error => {
                hideLoading();
                console.error('Lỗi khi tải dữ liệu:', error);
                showError();
            });
    }

    // Hiển thị loading
    function showLoading() {
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('menuTableBody').innerHTML = '';
    }

    // Ẩn loading
    function hideLoading() {
        document.getElementById('loadingSpinner').style.display = 'none';
    }

    // Hiển thị lỗi
    function showError() {
        document.getElementById('menuTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4">
                    <i class="fas fa-exclamation-triangle text-warning fa-2x mb-2"></i>
                    <div>Có lỗi xảy ra khi tải dữ liệu</div>
                </td>
            </tr>
        `;
    }

    // Hiển thị bảng món ăn
    function renderMenuTable(items) {
        const tbody = document.getElementById('menuTableBody');

        if (items.length === 0) {
            document.getElementById('emptyState').style.display = 'block';
            tbody.innerHTML = '';
            return;
        }

        document.getElementById('emptyState').style.display = 'none';
        tbody.innerHTML = '';

        items.forEach(item => {
            const isAvailable = item.status === 'AVAILABLE';
            const statusClass = isAvailable ? 'status-available' : 'status-unavailable';
            const statusText = isAvailable ? 'Available' : 'Unavailable';
            const actionButton = isAvailable
                ? `<button class="btn btn-outline-danger btn-sm" onclick="deleteItem(${item.id})" title="Xóa">
                     <i class="fas fa-trash"></i>
                   </button>`
                : `<button class="btn btn-outline-success btn-sm" onclick="restoreItem(${item.id})" title="Khôi phục">
                     <i class="fas fa-undo"></i>
                   </button>`;

            const row = `
                <tr>
                    <td>
                        ${item.imageUrl
                ? `<img src="${item.imageUrl}" class="menu-image" alt="${item.name}" onerror="this.outerHTML='<div class=&quot;menu-image bg-light d-flex align-items-center justify-content-center&quot;><i class=&quot;fas fa-image text-muted&quot;></i></div>';">`
                : `<div class="menu-image bg-light d-flex align-items-center justify-content-center">
                                 <i class="fas fa-image text-muted"></i>
                               </div>`
            }
                    </td>
                    <td>
                        <div class="fw-bold">${item.name}</div>
                    </td>
                    <td>
                        <div class="text-muted" style="max-width: 200px;">
                            ${item.description || 'Không có mô tả'}
                        </div>
                    </td>
                    <td>
                        <span class="price-text">${Number(item.price).toLocaleString()} VND</span>
                    </td>
                    <td>
                        <div style="max-width: 150px;">
                            ${item.categoryNames.join(', ') || ''}
                        </div>
                    </td>
                    <td>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-outline-primary btn-sm me-1" onclick="editItem(${item.id})" title="Chỉnh sửa">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${actionButton}
                        </div>
                    </td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
        });
    }

    // Phân trang
    function renderPagination(totalPages, currentPageIndex) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        if (totalPages <= 1) return;

        const prevDisabled = currentPageIndex === 0 ? 'disabled' : '';
        pagination.innerHTML += `
            <li class="page-item ${prevDisabled}">
                <a class="page-link" href="#" onclick="changePage(${currentPageIndex - 1})">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>`;

        const startPage = Math.max(0, currentPageIndex - 2);
        const endPage = Math.min(totalPages - 1, currentPageIndex + 2);

        if (startPage > 0) {
            pagination.innerHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" onclick="changePage(0)">1</a>
                </li>`;
            if (startPage > 1) {
                pagination.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            const active = currentPageIndex === i ? 'active' : '';
            pagination.innerHTML += `
                <li class="page-item ${active}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i + 1}</a>
                </li>`;
        }

        if (endPage < totalPages - 1) {
            if (endPage < totalPages - 2) {
                pagination.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            pagination.innerHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" onclick="changePage(${totalPages - 1})">${totalPages}</a>
                </li>`;
        }

        const nextDisabled = currentPageIndex === totalPages - 1 ? 'disabled' : '';
        pagination.innerHTML += `
            <li class="page-item ${nextDisabled}">
                <a class="page-link" href="#" onclick="changePage(${currentPageIndex + 1})">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>`;
    }

    // Thay đổi trang
    function changePage(page) {
        if (page < 0) return;
        currentPage = page;
        fetchMenuItems();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Chỉnh sửa món ăn
    function editItem(id) {
        window.location.href = `/foodhub/menu-manager/edit-dish.html?id=${id}`;
    }

    // Xóa món ăn
    function deleteItem(id) {
        if (confirm('Bạn có chắc chắn muốn xóa món ăn này?\n(Món ăn sẽ chuyển sang trạng thái UNAVAILABLE)')) {
            const deleteButton = document.querySelector(`button[onclick="deleteItem(${id})"]`);
            const originalText = deleteButton.innerHTML;
            deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            deleteButton.disabled = true;

            axios.delete(`${apiMenuUrl}/${id}`)
                .then(response => {
                    if (response.data.success) {
                        showNotification(response.data.message, 'success');
                        fetchMenuItems();
                    } else {
                        showNotification(response.data.message || 'Có lỗi xảy ra', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error deleting item:', error);
                    showNotification('Không thể xóa món ăn. Vui lòng thử lại!', 'error');
                })
                .finally(() => {
                    deleteButton.innerHTML = originalText;
                    deleteButton.disabled = false;
                });
        }
    }

    // Khôi phục món ăn
    function restoreItem(id) {
        if (confirm('Bạn có chắc chắn muốn khôi phục món ăn này?\n(Món ăn sẽ chuyển sang trạng thái AVAILABLE)')) {
            const restoreButton = document.querySelector(`button[onclick="restoreItem(${id})"]`);
            const originalText = restoreButton.innerHTML;
            restoreButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            restoreButton.disabled = true;

            axios.put(`${apiMenuUrl}/${id}/restore`)
                .then(response => {
                    if (response.data.success) {
                        showNotification(response.data.message, 'success');
                        fetchMenuItems();
                    } else {
                        showNotification(response.data.message || 'Có lỗi xảy ra', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error restoring item:', error);
                    showNotification('Không thể khôi phục món ăn. Vui lòng thử lại!', 'error');
                })
                .finally(() => {
                    restoreButton.innerHTML = originalText;
                    restoreButton.disabled = false;
                });
        }
    }

    // Hiển thị thông báo
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed notification-enter`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }

    // Event listeners
    document.getElementById('filterForm').addEventListener('submit', e => {
        e.preventDefault();
        currentPage = 0;
        fetchMenuItems();
    });

    // Khởi tạo
    fetchCategories();
    fetchMenuItems();
</script>
</body>
</html>