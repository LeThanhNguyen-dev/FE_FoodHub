<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FoodHub - Đăng nhập</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <style>
    :root {
      --primary-dark: #0F172B;
      --primary-gold: #FEA116;
      --light-gold: #F7E6A3;
      --bg-gradient-start: #1a1a2e;
      --bg-gradient-end: #16213e;
      --glass-bg: rgba(255, 255, 255, 0.95);
      --glass-border: rgba(255, 255, 255, 0.2);
      --shadow-light: rgba(0, 0, 0, 0.1);
      --shadow-medium: rgba(0, 0, 0, 0.15);
      --shadow-heavy: rgba(0, 0, 0, 0.25);
      --text-primary: #2d3748;
      --text-secondary: #718096;
      --success: #48bb78;
      --error: #f56565;
      --warning: #ed8936;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow-x: hidden;
    }

    /* Animated background particles */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(254, 161, 22, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(247, 230, 163, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(15, 23, 43, 0.1) 0%, transparent 50%);
      animation: float 20s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(180deg); }
    }

    .login-container {
      max-width: 1000px;
      width: 100%;
      margin: 20px;
      position: relative;
    }

    .login-wrapper {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      box-shadow: 
        0 8px 32px var(--shadow-heavy),
        0 0 0 1px rgba(255, 255, 255, 0.1);
      overflow: hidden;
      display: flex;
      min-height: 600px;
      position: relative;
    }

    .login-wrapper::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-gold), var(--light-gold), var(--primary-gold));
      animation: shimmer 3s ease-in-out infinite;
    }

    @keyframes shimmer {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .intro-section {
      flex: 1;
      background: linear-gradient(135deg, rgba(15, 23, 43, 0.95) 0%, rgba(26, 26, 46, 0.95) 100%),
        url('https://images.unsplash.com/photo-1414235077428-338989a2e8c0?auto=format&fit=crop&w=800&q=80');
      background-size: cover;
      background-position: center;
      padding: 3rem;
      color: var(--light-gold);
      display: flex;
      flex-direction: column;
      justify-content: center;
      position: relative;
    }

    .intro-section::before {
      content: '';
      position: absolute;
      top: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: var(--primary-gold);
      border-radius: 50%;
      opacity: 0.1;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.1; }
      50% { transform: scale(1.1); opacity: 0.2; }
    }

    .brand-logo {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 2rem;
    }

    .logo-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--primary-gold), var(--light-gold));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: var(--primary-dark);
      font-weight: bold;
    }

    .brand-name {
      font-family: 'Pacifico', cursive;
      font-size: 4rem;
      font-weight: 700;
      color: var(--primary-gold);
    }

    .intro-section h2 {
      font-family: 'Montserrat', sans-serif;
      font-size: 2.5rem;
      font-weight: 700;
      color: white;
      margin-bottom: 1.5rem;
      line-height: 1.2;
    }

    .intro-section p {
      font-size: 1.1rem;
      color: var(--light-gold);
      line-height: 1.7;
      opacity: 0.9;
    }

    .features-list {
      margin-top: 2rem;
      list-style: none;
      padding: 0;
    }

    .features-list li {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      font-size: 0.95rem;
      color: var(--light-gold);
    }

    .features-list i {
      color: var(--primary-gold);
      width: 16px;
    }

    .login-section {
      flex: 1;
      padding: 3rem;
      background: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      position: relative;
    }

    .login-header {
      text-align: center;
      margin-bottom: 2.5rem;
    }

    .login-section h2 {
      font-family: 'Inter', sans-serif;
      font-size: 2.2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .login-subtitle {
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: 400;
    }

    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      border: none;
      font-size: 0.9rem;
      display: none;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .alert-error {
      background-color: rgba(245, 101, 101, 0.1);
      color: var(--error);
      border-left: 4px solid var(--error);
    }

    .alert-success {
      background-color: rgba(72, 187, 120, 0.1);
      color: var(--success);
      border-left: 4px solid var(--success);
    }

    .form-group {
      margin-bottom: 1.5rem;
      position: relative;
    }

    .form-group label {
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      display: block;
      font-size: 0.95rem;
    }

    .input-wrapper {
      position: relative;
    }

    .form-group input {
      width: 100%;
      padding: 14px 16px;
      padding-left: 45px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background-color: #f8fafc;
      font-family: 'Inter', sans-serif;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary-gold);
      background-color: white;
      box-shadow: 0 0 0 3px rgba(254, 161, 22, 0.1);
      transform: translateY(-1px);
    }

    .input-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      font-size: 1.1rem;
      transition: color 0.3s ease;
    }

    .form-group input:focus + .input-icon {
      color: var(--primary-gold);
    }

    .password-toggle {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1.1rem;
      transition: color 0.3s ease;
    }

    .password-toggle:hover {
      color: var(--primary-gold);
    }

    .form-options {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .remember-me {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .remember-me input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary-gold);
      margin: 0;
    }

    .remember-me label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0;
      cursor: pointer;
    }

    .forgot-password {
      font-size: 0.9rem;
      color: var(--primary-gold);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .forgot-password:hover {
      color: var(--light-gold);
      text-decoration: underline;
    }

    .btn-submit {
      background: linear-gradient(135deg, var(--primary-gold), #f6b73c);
      color: white;
      border: none;
      padding: 14px 20px;
      width: 100%;
      font-weight: 600;
      border-radius: 10px;
      font-size: 1.05rem;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-submit::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-submit:hover::before {
      left: 100%;
    }

    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(254, 161, 22, 0.3);
    }

    .btn-submit:active {
      transform: translateY(0);
    }

    .btn-submit:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .loading-spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 2px solid transparent;
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .divider {
      position: relative;
      text-align: center;
      margin: 2rem 0;
    }

    .divider::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: #e2e8f0;
    }

    .divider span {
      background: white;
      padding: 0 20px;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .btn-google {
      background-color: white;
      border: 2px solid #e2e8f0;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 12px 20px;
      width: 100%;
      border-radius: 10px;
      font-weight: 500;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }

    .btn-google:hover {
      border-color: #db4437;
      background-color: #fafafa;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--shadow-light);
    }

    .btn-google i {
      font-size: 1.2rem;
      color: #db4437;
    }

    .signup-link {
      text-align: center;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e2e8f0;
    }

    .signup-link p {
      color: var(--text-secondary);
      font-size: 0.95rem;
      margin-bottom: 8px;
    }

    .signup-link a {
      color: var(--primary-gold);
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .signup-link a:hover {
      color: var(--light-gold);
      text-decoration: underline;
    }

    /* Input validation styles */
    .form-group input.valid {
      border-color: var(--success);
      background-color: rgba(72, 187, 120, 0.05);
    }

    .form-group input.invalid {
      border-color: var(--error);
      background-color: rgba(245, 101, 101, 0.05);
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .login-container {
        margin: 10px;
      }

      .login-wrapper {
        flex-direction: column;
        min-height: auto;
      }

      .intro-section {
        padding: 2rem;
        min-height: 300px;
      }

      .intro-section h2 {
        font-size: 2rem;
      }

      .login-section {
        padding: 2rem;
      }

      .login-section h2 {
        font-size: 1.8rem;
      }

      .form-options {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }
    }

    @media (max-width: 480px) {
      .intro-section,
      .login-section {
        padding: 1.5rem;
      }

      .intro-section h2 {
        font-size: 1.8rem;
      }

      .login-section h2 {
        font-size: 1.6rem;
      }

      .brand-logo {
        gap: 10px;
      }

      .logo-icon {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
      }

      .brand-name {
        font-size: 1.5rem;
      }
    }
  </style>
</head>

<body>
  <div class="login-container">
    <div class="login-wrapper">
      <div class="intro-section">
        <div class="brand-logo">
          <div class="brand-name">FoodHub</div>
        </div>
        <h2>Chào mừng trở lại!</h2>
        <p>Khám phá thế giới ẩm thực tuyệt vời với những món ăn được chế biến từ nguyên liệu tươi ngon nhất. Hãy đăng nhập để trải nghiệm dịch vụ đẳng cấp của chúng tôi.</p>
        
        <ul class="features-list">
          <li><i class="fas fa-check"></i> Thực đơn đa dạng, phong phú</li>
          <li><i class="fas fa-check"></i> Đặt hàng nhanh chóng, tiện lợi</li>
          <li><i class="fas fa-check"></i> Giao hàng tận nơi</li>
          <li><i class="fas fa-check"></i> Hỗ trợ 24/7</li>
        </ul>
      </div>
      
      <div class="login-section">
        <div class="login-header">
          <h2>Đăng nhập</h2>
          <p class="login-subtitle">Nhập thông tin để truy cập tài khoản của bạn</p>
        </div>

        <div id="alertMsg" class="alert"></div>

        <form id="loginForm">
          <div class="form-group">
            <label for="username">Email</label>
            <div class="input-wrapper">
              <input type="email" id="username" name="username" required autocomplete="email" />
              <i class="fas fa-envelope input-icon"></i>
            </div>
          </div>

          <div class="form-group">
            <label for="password">Mật khẩu</label>
            <div class="input-wrapper">
              <input type="password" id="password" name="password" required autocomplete="current-password" />
              <i class="fas fa-lock input-icon"></i>
              <button type="button" class="password-toggle" onclick="togglePassword()">
                <i class="fas fa-eye" id="passwordToggleIcon"></i>
              </button>
            </div>
          </div>

          <div class="form-options">
            <div class="remember-me">
              <input type="checkbox" id="rememberMe" name="rememberMe" />
              <label for="rememberMe">Ghi nhớ đăng nhập</label>
            </div>
            <a href="forgot-password.html" class="forgot-password">Quên mật khẩu?</a>
          </div>

          <button type="submit" class="btn-submit" id="loginBtn">
            <span class="loading-spinner" id="loadingSpinner"></span>
            <span id="loginBtnText">Đăng nhập</span>
          </button>
        </form>

        <div class="divider">
          <span>Hoặc</span>
        </div>

        <button type="button" class="btn-google" onclick="loginWithGoogle()">
          <i class="fab fa-google"></i>
          <span>Đăng nhập bằng Google</span>
        </button>

        <div class="signup-link">
          <p>Chưa có tài khoản?</p>
          <a href="register.html">Đăng ký ngay</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:8080';

    // Initialize page
    window.addEventListener("load", () => {
      const params = new URLSearchParams(window.location.search);
      const token = params.get("token");
      if (token) {
        localStorage.setItem("accessToken", token);
        const payload = parseJwt(token);
        redirectBasedOnRole(payload);
      }
    });

    // Show alert messages
    function showAlert(message, type = 'error') {
      const alertEl = document.getElementById('alertMsg');
      alertEl.className = `alert alert-${type}`;
      alertEl.textContent = message;
      alertEl.style.display = 'block';
      
      // Auto hide after 5 seconds
      setTimeout(() => {
        hideAlert();
      }, 5000);
    }

    function hideAlert() {
      const alertEl = document.getElementById('alertMsg');
      alertEl.style.display = 'none';
    }

    // Toggle password visibility
    function togglePassword() {
      const passwordInput = document.getElementById('password');
      const toggleIcon = document.getElementById('passwordToggleIcon');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.className = 'fas fa-eye-slash';
      } else {
        passwordInput.type = 'password';
        toggleIcon.className = 'fas fa-eye';
      }
    }

    // Google login
    function loginWithGoogle() {
      window.location.href = API_BASE_URL + "/oauth2/authorization/google";
    }

    // API fetch utility
    async function apiFetch(endpoint, options = {}) {
      const url = endpoint.startsWith('http') ? endpoint : API_BASE_URL + endpoint;
      try {
        const response = await fetch(url, options);
        const json = await response.json();
        if (!response.ok) {
          throw new Error(json?.message || 'Đăng nhập thất bại.');
        }
        return json;
      } catch (err) {
        throw new Error(err.message || 'Lỗi kết nối đến server.');
      }
    }

    // Parse JWT token
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
          '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        return null;
      }
    }

    // Redirect based on user role
    function redirectBasedOnRole(payload) {
      const scopes = payload?.scope?.split(" ");
      if (scopes.includes("ROLE_ADMIN")) {
        window.location.href = '../../adminDashboard/adminDashboard.html';
      } else if (scopes.includes("ROLE_WAITER")) {
        window.location.href = '../../waiter/index.html';
      } else if (scopes.includes("ROLE_CHEF")) {
        window.location.href = '../../chef/index.html';
      } else if (scopes.includes("ROLE_CASHIER")) {
        window.location.href = '../../cashier/index.html';
      } else if (scopes.includes("ROLE_CUSTOMER")) {
        window.location.href = 'home.html';
      } else {
        window.location.href = 'adminDashboard/adminDashboard.html';
      }
    }

    // Input validation
    function validateEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    function validatePassword(password) {
      return password.length >= 6;
    }

    // Real-time input validation
    document.getElementById('username').addEventListener('input', function(e) {
      const input = e.target;
      if (input.value && validateEmail(input.value)) {
        input.classList.add('valid');
        input.classList.remove('invalid');
      } else if (input.value) {
        input.classList.add('invalid');
        input.classList.remove('valid');
      } else {
        input.classList.remove('valid', 'invalid');
      }
    });

    document.getElementById('password').addEventListener('input', function(e) {
      const input = e.target;
      if (input.value && validatePassword(input.value)) {
        input.classList.add('valid');
        input.classList.remove('invalid');
      } else if (input.value) {
        input.classList.add('invalid');
        input.classList.remove('valid');
      } else {
        input.classList.remove('valid', 'invalid');
      }
    });

    // Form submission
    document.getElementById('loginForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      
      const loginBtn = document.getElementById('loginBtn');
      const loginBtnText = document.getElementById('loginBtnText');
      const loadingSpinner = document.getElementById('loadingSpinner');
      
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;

      // Client-side validation
      if (!validateEmail(username)) {
        showAlert('Vui lòng nhập email hợp lệ.');
        return;
      }

      if (!validatePassword(password)) {
        showAlert('Mật khẩu phải có ít nhất 6 ký tự.');
        return;
      }

      // Show loading state
      loginBtn.disabled = true;
      loadingSpinner.style.display = 'inline-block';
      loginBtnText.textContent = 'Đang đăng nhập...';
      hideAlert();

      try {
        const data = await apiFetch('/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const token = data.result.token;
        localStorage.setItem('accessToken', token);
        
        // Save remember me preference
        if (document.getElementById('rememberMe').checked) {
          localStorage.setItem('rememberMe', 'true');
          localStorage.setItem('savedEmail', username);
        } else {
          localStorage.removeItem('rememberMe');
          localStorage.removeItem('savedEmail');
        }

        showAlert('Đăng nhập thành công! Đang chuyển hướng...', 'success');
        
        // Redirect after short delay
        setTimeout(() => {
          const payload = parseJwt(token);
          redirectBasedOnRole(payload);
        }, 1000);

      } catch (err) {
        showAlert(err.message);
      } finally {
        // Reset button state
        loginBtn.disabled = false;
        loadingSpinner.style.display = 'none';
        loginBtnText.textContent = 'Đăng nhập';
      }
    });

    // Load saved email if remember me was checked
    window.addEventListener('load', () => {
      if (localStorage.getItem('rememberMe') === 'true') {
        const savedEmail = localStorage.getItem('savedEmail');
        if (savedEmail) {
          document.getElementById('username').value = savedEmail;
          document.getElementById('rememberMe').checked = true;
        }
      }
    });

    // Handle enter key in password field
    document.getElementById('password').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('loginForm').dispatchEvent(new Event('submit'));
      }
    });






//28/6, thêm để  logout rồi thì khi ấn back trên trang login sẽ không về lại trang cũ mà qua trang google 
 // Hàm mới: Xử lý nút Back của trình duyệt
    function handleBrowserBack() {
      window.history.pushState({ redirect: 'login' }, '', window.location.href);
      window.addEventListener('popstate', function(event) {
        console.log('Popstate event triggered: Navigating to Google');
        window.location.replace('https://www.google.com');
      });
    }

    // Gọi hàm handleBrowserBack khi trang tải
    window.addEventListener('load', handleBrowserBack);

  </script>
</body>

</html>