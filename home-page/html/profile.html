<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    .gradient-bg {
      background: #0F172B;
    }

    .sidebar-link {
      transition: all 0.3s ease;
    }

    .sidebar-link:hover {
      background-color: #FEA116;
      transform: translateX(5px);
    }

    .content-area {
      transition: all 0.3s ease;
    }

    .btn-orange {
      background-color: #FEA116;
      transition: all 0.3s ease;
    }

    .btn-orange:hover {
      background-color: #FEA116;
      transform: translateY(-2px);
    }

    .frame {
      background-color: #0F172B;;
      border: 2px solid #FEA116;
    }

    .input-focus {
      transition: all 0.3s ease;
    }

    .input-focus:focus {
      border-color: #FEA116;
      box-shadow: 0 0 8px #FEA116;
    }
  </style>
</head>

<body class="gradient-bg min-h-screen flex font-sans">
  <!-- Sidebar -->
  <aside class="w-64 bg-[#0F172B] border-r-2 border-orange-500 shadow-lg flex flex-col justify-between">
    <div>
      <div class="p-6 border-b border-orange-500">
        <h2 class="text-2xl font-bold text-orange-500">User Dashboard</h2>
        <p id="username-greeting" class="text-sm text-gray-300 mt-1">Welcome, User!</p>
      </div>
      <nav class="mt-4">
        <a href="#profile" id="profile-link"
          class="sidebar-link flex items-center px-6 py-3 text-orange-500 font-semibold hover:text-white">
          <i class="fas fa-user mr-3"></i> Edit Profile
        </a>
        <a href="#password" id="password-link"
          class="sidebar-link flex items-center px-6 py-3 text-orange-500 font-semibold hover:text-white">
          <i class="fas fa-key mr-3"></i> Change Password
        </a>
        <a href="#order-status" id="order-status-link"
          class="sidebar-link flex items-center px-6 py-3 text-orange-500 font-semibold hover:text-white">
          <i class="fas fa-shipping-fast mr-3"></i> Order Status
        </a>
        <a href="#order-history" id="order-history-link"
          class="sidebar-link flex items-center px-6 py-3 text-orange-500 font-semibold hover:text-white">
          <i class="fas fa-history mr-3"></i> Order History
        </a>
        <a href="home.html" id="home-link"
          class="sidebar-link flex items-center px-6 py-3 text-orange-500 font-semibold hover:text-white">
          <i class="fas fa-home mr-3"></i> Back to Home
        </a>
      </nav>
    </div>
    <div class="p-6 border-t border-orange-500">
      <button id="logout-button"
        class="w-full flex items-center justify-center btn-orange text-white py-2 px-4 rounded-lg font-semibold">
        <i class="fas fa-sign-out-alt mr-2"></i> Logout
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-8 overflow-auto">
    <div id="content-area" class="content-area max-w-4xl mx-auto space-y-8">
      <!-- Profile Section -->
      <div id="profile-section" class="frame rounded-2xl shadow-xl p-8">
        <h2 class="text-3xl font-extrabold text-orange-500 mb-6">Edit Profile</h2>
        <div id="error-message" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-center"></div>
        <div id="success-message" class="hidden bg-green-100 text-green-700 p-3 rounded-lg mb-4 text-center"></div>
        <div class="space-y-6">
          <div class="relative">
            <label for="username" class="block text-sm font-semibold text-orange-500 mb-1">Username</label>
            <div class="flex items-center">
              <i class="fas fa-user absolute ml-3 text-gray-300"></i>
              <input type="text" id="username"
                class="pl-10 w-full bg-gray-700 text-white border-gray-600 rounded-lg shadow-sm input-focus" readonly>
            </div>
          </div>
          <div class="relative">
            <label for="email" class="block text-sm font-semibold text-orange-500 mb-1">Email</label>
            <div class="flex items-center">
              <i class="fas fa-envelope absolute ml-3 text-gray-300"></i>
              <input type="email" id="email"
                class="pl-10 w-full bg-gray-700 text-white border-gray-600 rounded-lg shadow-sm input-focus">
            </div>
          </div>
          <div class="relative">
            <label for="phone" class="block text-sm font-semibold text-orange-500 mb-1">Phone Number</label>
            <div class="flex items-center">
              <i class="fas fa-phone absolute ml-3 text-gray-300"></i>
              <input type="tel" id="phone"
                class="pl-10 w-full bg-gray-700 text-white border-gray-600 rounded-lg shadow-sm input-focus">
            </div>
          </div>
          <div class="relative">
            <label for="address" class="block text-sm font-semibold text-orange-500 mb-1">Address</label>
            <div class="flex items-center">
              <i class="fas fa-map-marker-alt absolute ml-3 text-gray-300"></i>
              <input type="text" id="address"
                class="pl-10 w-full bg-gray-700 text-white border-gray-600 rounded-lg shadow-sm input-focus">
            </div>
          </div>
          <button id="save-button"
            class="w-full btn-orange text-white py-3 px-4 rounded-lg font-semibold flex items-center justify-center">
            <i class="fas fa-save mr-2"></i> Save Changes
          </button>
        </div>
      </div>

      <!-- Password Change Section -->
      <div id="password-section" class="hidden frame rounded-2xl shadow-xl p-8">
        <h2 class="text-3xl font-extrabold text-orange-500 mb-6">Change Password</h2>
        <div id="password-error-message" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-center"></div>
        <div id="password-success-message" class="hidden bg-green-100 text-green-700 p-3 rounded-lg mb-4 text-center">
        </div>
        <div class="space-y-6">
          <div class="relative">
            <label for="old-password" class="block text-sm font-semibold text-orange-500 mb-1">Current Password</label>
            <div class="flex items-center">
              <i class="fas fa-lock absolute ml-3 text-gray-300"></i>
              <input type="password" id="old-password"
                class="pl-10 w-full bg-gray-700 text-white border-gray-600 rounded-lg shadow-sm input-focus">
            </div>
          </div>
          <div class="relative">
            <label for="new-password" class="block text-sm font-semibold text-orange-500 mb-1">New Password</label>
            <div class="flex items-center">
              <i class="fas fa-key absolute ml-3 text-gray-300"></i>
              <input type="password" id="new-password"
                class="pl-10 w-full bg-gray-700 text-white border-gray-600 rounded-lg shadow-sm input-focus">
            </div>
          </div>
          <button id="change-password-button"
            class="w-full btn-orange text-white py-3 px-4 rounded-lg font-semibold flex items-center justify-center">
            <i class="fas fa-edit mr-2"></i> Change Password
          </button>
        </div>
      </div>

      <!-- Order Status Section -->
      <div id="order-status-section" class="hidden frame rounded-2xl shadow-xl p-8">
        <h2 class="text-3xl font-extrabold text-orange-500 mb-6">Order Status</h2>
        <div id="order-status-content" class="bg-gray-700 text-white p-4 rounded-lg">
          <p>No active orders found.</p>
        </div>
      </div>

      <!-- Order History Section -->
      <div id="order-history-section" class="hidden frame rounded-2xl shadow-xl p-8">
        <h2 class="text-3xl font-extrabold text-orange-500 mb-6">Order History</h2>
        <div id="order-history-content" class="bg-gray-700 text-white p-4 rounded-lg">
          <p>No order history available.</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    const API_BASE_URL = 'http://localhost:8080';

    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
          '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        console.error("Invalid token:", e);
        return null;
      }
    }

    function isLoggedIn() {
      const token = localStorage.getItem('accessToken');
      if (!token) return false;
      const payload = parseJwt(token);
      return payload && payload.exp * 1000 > Date.now() && payload.scope === 'ROLE_CUSTOMER';
    }

    function logout() {
      localStorage.removeItem('accessToken');
      localStorage.removeItem('cart');
      window.location.href = 'login.html';
    }

    function showError(message, section = 'profile') {
      const errorDiv = document.getElementById(section === 'password' ? 'password-error-message' : 'error-message');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      document.getElementById(section === 'password' ? 'password-success-message' : 'success-message').classList.add('hidden');
    }

    function showSuccess(message, section = 'profile') {
      const successDiv = document.getElementById(section === 'password' ? 'password-success-message' : 'success-message');
      successDiv.textContent = message;
      successDiv.classList.remove('hidden');
      document.getElementById(section === 'password' ? 'password-error-message' : 'error-message').classList.add('hidden');
    }

    async function fetchUserInfo() {
      try {
        const token = localStorage.getItem('accessToken');
        const payload = parseJwt(token);
        const userId = payload.id;

        const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!response.ok) throw new Error('Failed to fetch user info');
        const data = await response.json();
        const user = data.result;
        document.getElementById('username').value = user.username || '';
        document.getElementById('email').value = user.email || '';
        document.getElementById('phone').value = user.phone || '';
        document.getElementById('address').value = user.address || '';
        document.getElementById('username-greeting').textContent = `Welcome, ${user.username || 'User'}!`;
      } catch (error) {
        showError('Error fetching info: ' + error.message);
      }
    }

    async function saveUserInfo() {
      if (!isLoggedIn()) {
        showError('Please login to save changes!');
        window.location.href = 'login.html';
        return;
      }

      const token = localStorage.getItem('accessToken');
      const payload = parseJwt(token);
      const userId = payload.id;

      const request = {
        email: document.getElementById('email').value,
        phoneNumber: document.getElementById('phone').value,
        address: document.getElementById('address').value
      };

      try {
        const response = await fetch(`${API_BASE_URL}/users/cus/${userId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(request)
        });
        if (!response.ok) throw new Error('Failed to update info');
        const data = await response.json();
        showSuccess(data.message || 'Profile updated successfully!');
      } catch (error) {
        showError('Error updating: ' + error.message);
      }
    }

    async function changePassword() {
      if (!isLoggedIn()) {
        showError('Please login!', 'password');
        window.location.href = 'login.html';
        return;
      }

      const request = {
        oldPassword: document.getElementById('old-password').value,
        newPassword: document.getElementById('new-password').value
      };

      if (!request.oldPassword || !request.newPassword) {
        showError('Please enter both old and new passwords.', 'password');
        return;
      }

      try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch(`${API_BASE_URL}/users/change-password`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(request)
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.message || 'Password change failed');
        showSuccess(data.message || 'Password changed successfully!', 'password');
        document.getElementById('old-password').value = '';
        document.getElementById('new-password').value = '';
      } catch (error) {
        showError('Error changing password: ' + error.message, 'password');
      }
    }

    function switchSection(sectionId) {
      document.querySelectorAll('#content-area > div').forEach(div => div.classList.add('hidden'));
      document.getElementById(sectionId).classList.remove('hidden');
      document.querySelectorAll('nav a').forEach(link => link.classList.remove('bg-orange-500', 'text-white'));
      document.getElementById(`${sectionId}-link`).classList.add('bg-orange-500', 'text-white');
    }

    async function fetchOrderStatus() {
      try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch(`${API_BASE_URL}/orders/status`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!response.ok) throw new Error('Failed to fetch order status');
        const data = await response.json();
        const content = document.getElementById('order-status-content');
        content.innerHTML = data.result.length
          ? data.result.map(order => `<div class="mb-4"><p>Order #${order.id}: ${order.status}</p></div>`).join('')
          : '<p>No active orders found.</p>';
      } catch (error) {
        showError('Error fetching order status: ' + error.message);
      }
    }

    async function fetchOrderHistory() {
      try {
        const token = localStorage.getItem('accessToken');
        const response = await fetch(`${API_BASE_URL}/orders/history`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!response.ok) throw new Error('Failed to fetch order history');
        const data = await response.json();
        const content = document.getElementById('order-history-content');
        content.innerHTML = data.result.length
          ? data.result.map(order => `<div class="mb-4"><p>Order #${order.id}: ${order.status} - ${new Date(order.date).toLocaleDateString()}</p></div>`).join('')
          : '<p>No order history available.</p>';
      } catch (error) {
        showError('Error fetching order history: ' + error.message);
      }
    }

    function updateUI() {
      if (!isLoggedIn()) {
        showError('Please login to access dashboard!');
        window.location.href = 'login.html';
        return;
      }
      fetchUserInfo();
      switchSection('profile-section');
    }

    document.getElementById('save-button').addEventListener('click', saveUserInfo);
    document.getElementById('change-password-button').addEventListener('click', changePassword);
    document.getElementById('logout-button').addEventListener('click', logout);
    document.getElementById('profile-link').addEventListener('click', () => switchSection('profile-section'));
    document.getElementById('password-link').addEventListener('click', () => switchSection('password-section'));
    document.getElementById('order-status-link').addEventListener('click', () => {
      switchSection('order-status-section');
      fetchOrderStatus();
    });
    document.getElementById('order-history-link').addEventListener('click', () => {
      switchSection('order-history-section');
      fetchOrderHistory();
    });
    document.addEventListener('DOMContentLoaded', updateUI);
  </script>
</body>

</html>