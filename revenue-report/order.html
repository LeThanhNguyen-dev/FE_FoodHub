<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <title>FoodHub Admin - Quản lý đơn hàng</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600&family=Nunito:wght@600;700;800&family=Pacifico&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/orderList.css">
</head>
<body>
    <!-- Sidebar Include -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="d-flex align-items-center">
                <button class="toggle-sidebar me-3" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h4 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Quản lý đơn hàng</h4>
            </div>
            <div class="d-flex align-items-center">
                <div class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle me-2"></i>Admin
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>Hồ sơ</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Cài đặt</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt me-2"></i>Đăng xuất</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Order Management Content -->
        <div class="container-fluid p-4">
            <!-- Filter Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-filter me-2"></i>Bộ lọc và Tìm kiếm</h5>
                </div>
                <div class="card-body">
                    <form id="filterForm" class="row g-3">
                        <div class="col-md-3">
                            <label for="periodSelect" class="form-label fw-bold">Thời gian</label>
                            <select id="period" class="form-select">
                                <option value="today">Hôm nay</option>
                                <option value="week">Tuần này</option>
                                <option value="month" selected>Tháng này</option>
                                <option value="year">Năm này</option>
                                <option value="custom">Tùy chỉnh</option>
                            </select>
                            <div id="customDate" style="display: none; margin-top: 10px;">
                                <input type="date" id="startDate" class="form-control" placeholder="Từ ngày">
                                <input type="date" id="endDate" class="form-control mt-2" placeholder="Đến ngày">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="searchInput" class="form-label fw-bold">Tìm kiếm</label>
                            <input type="text" id="searchInput" class="form-control" placeholder="Nhập mã hoặc khách hàng...">
                        </div>
                        <div class="col-md-3">
                            <label for="orderTypeFilter" class="form-label fw-bold">Loại đơn</label>
                            <select id="orderTypeFilter" class="form-select">
                                <option value="">Tất cả loại đơn</option>
                                <option value="DINE_IN">Tại quán</option>
                                <option value="TAKEAWAY">Mang về</option>
                                <option value="DELIVERY">Giao hàng</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="paymentMethodFilter" class="form-label fw-bold">Phương thức thanh toán</label>
                            <select id="paymentMethodFilter" class="form-select">
                                <option value="">Tất cả phương thức</option>
                                <option value="CASH">CASH</option>
                                <option value="BANKING">BANKING</option>
                                <option value="VNPAY">VNPAY</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="minPrice" class="form-label fw-bold">Tổng tiền từ</label>
                            <input type="number" id="minPrice" class="form-control" placeholder="Tổng tiền từ">
                        </div>
                        <div class="col-md-3">
                            <label for="maxPrice" class="form-label fw-bold">Tổng tiền đến</label>
                            <input type="number" id="maxPrice" class="form-control" placeholder="Tổng tiền đến">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search me-2"></i>Lọc
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Order Table Card -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list me-2"></i>Danh sách đơn hàng</h5>
                </div>
                <div class="card-body">
                    <!-- Loading Spinner -->
                    <div id="loadingSpinner" class="text-center py-5" style="display: none;">
                        <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                        <p class="mt-3 text-muted">Đang tải dữ liệu...</p>
                    </div>

                    <!-- Order Table -->
                    <div id="orderTable" class="table-responsive">
                        <table class="table table-hover align-middle">
                           <thead>
    <tr>
        <th style="width: 60px;">STT</th>
        <th onclick="sortTable('id')" style="cursor: pointer;">
            Mã <span id="sort-id" class="sort-arrow"></span>
        </th>
        <th onclick="sortTable('createdAt')" style="cursor: pointer;">
            Ngày đặt <span id="sort-createdAt" class="sort-arrow"></span>
        </th>
        <th>Khách hàng</th>
        <th onclick="sortTable('totalAmount')" style="cursor: pointer;">
            Tổng tiền <span id="sort-totalAmount" class="sort-arrow"></span>
        </th>
        <th>Loại đơn</th>
        <th>Thanh toán</th>
        <th style="width: 150px;">Thao tác</th>
    </tr>
</thead>
                            <tbody id="orderTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="empty-state" style="display: none;">
                        <i class="fas fa-shopping-cart"></i>
                        <h5>Không có đơn hàng nào</h5>
                        <p class="text-muted">Thử thay đổi bộ lọc để xem thêm đơn hàng</p>
                    </div>

                    <!-- Pagination -->
                    <nav class="pagination-container">
                        <ul class="pagination justify-content-center" id="pagination"></ul>
                    </nav>
                </div>
            </div>

            <!-- Chart Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar me-2"></i>Số lượng đơn hoàn thành theo ngày</h5>
                </div>
                <div class="card-body">
                    <canvas id="summaryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Order Detail Popup -->
        <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="orderDetailModalLabel">Chi tiết đơn hàng</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="order-details row" id="orderDetails"></div>
                        <table class="table table-bordered mt-3">
                            <thead>
                                <tr>
                                    <th>Tên món</th>
                                    <th>Số lượng</th>
                                    <th>Đơn giá</th>
                                    <th>Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody"></tbody>
                        </table>
                        <p class="note" id="orderNote"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JS -->
    <script src="/js/fetch-api.js"></script>
    <script src="/js/sidebar.js"></script>
    <script>
        let summaryChart;
        let currentPage = 0;
        const pageSize = 10;
        let sortBy = 'createdAt';
        let sortDirection = 'ASC';
        let totalAmountAllPages = 0;

        async function loadSidebar() {
            try {
                const response = await fetch('/components/sidebar.html');
                if (!response.ok) throw new Error('Không thể tải sidebar');
                const sidebarHtml = await response.text();
                document.getElementById('sidebar-container').innerHTML = sidebarHtml;
                setActiveNavLink();
            } catch (error) {
                console.error('Lỗi khi tải sidebar:', error);
                showNotification('Lỗi tải sidebar!', 'error');
                document.getElementById('sidebar-container').innerHTML = '<p>Lỗi khi tải sidebar!</p>';
            }
        }

        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('orderTableBody').innerHTML = '';
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show notification`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr.replace('Z', '+07:00'));
            if (isNaN(date)) return 'N/A';
            return date.toLocaleString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }).replace(/\//g, '/');
        }

       function formatPaymentMethod(method) {
    // Kiểm tra null/undefined hoặc giá trị rỗng
    if (!method || method.trim() === '') {
        return 'Chưa xác định';
    }
    
    // Xử lý các phương thức thanh toán
    switch (method.toUpperCase()) {
        case 'CASH': 
            return 'CASH';
        case 'CARD': 
            return 'Thẻ';
        case 'BANKING': 
            return 'BANKING';
        case 'VNPAY': 
            return 'VNPAY';
        case 'QR_CODE': 
            return 'QR Code';
        default: 
            return method; // Trả về giá trị gốc nếu không khớp với case nào
    }
}

        function getQueryParams() {
            const period = document.getElementById('period').value;
            let params = `page=${currentPage}&size=${pageSize}&orderBy=${sortBy}&sort=${sortDirection}`;
            
           if (period === 'custom') {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (!startDate || !endDate) {
            showNotification('Vui lòng chọn ngày bắt đầu và kết thúc.', 'error');
            return null;
        }
        
        const startDateObj = new Date(startDate);
        const endDateObj = new Date(endDate);
        
        if (startDateObj > endDateObj) {
            showNotification('Ngày bắt đầu phải trước hoặc bằng ngày kết thúc.', 'error');
            return null;
        }
        
        // SỬA: Đổi từ period=custom thành period=specific và format UTC
        const startISO = `${startDate}T00:00:00Z`;
        const endISO = `${endDate}T23:59:59Z`;
        
        console.log('startISO:', startISO);
        console.log('endISO:', endISO);
        
        params += `&period=specific&startDate=${encodeURIComponent(startISO)}&endDate=${encodeURIComponent(endISO)}`;
    } else {
        params += `&period=${period}`;
    }
            
            const search = document.getElementById('searchInput').value.trim();
            if (search) params += `&search=${encodeURIComponent(search)}`;
            
            const orderType = document.getElementById('orderTypeFilter').value;
            if (orderType) params += `&orderType=${encodeURIComponent(orderType)}`;
            
            const minPrice = document.getElementById('minPrice').value;
            if (minPrice) params += `&minPrice=${encodeURIComponent(minPrice)}`;
            
            const maxPrice = document.getElementById('maxPrice').value;
            if (maxPrice) params += `&maxPrice=${encodeURIComponent(maxPrice)}`;
            
            const paymentMethod = document.getElementById('paymentMethodFilter').value;
            if (paymentMethod) params += `&paymentMethod=${encodeURIComponent(paymentMethod)}`;
            
            console.log('Final query params:', params);
            return params;
        }
        async function fetchTotalAmount() {
    const params = getQueryParams();
    if (!params) return 0;
    
    try {
        // Gọi API với size rất lớn để lấy tất cả đơn hàng
        const allOrdersParams = params.replace(`page=${currentPage}&size=${pageSize}`, 'page=0&size=10000');
        const response = await apiFetch(`/orders/completed/filtered?${allOrdersParams}`);
        
        if (response.code === 0 && response.result.content) {
            return response.result.content.reduce((total, order) => total + order.totalAmount, 0);
        }
        return 0;
    } catch (error) {
        console.error('Lỗi tính tổng tiền:', error);
        return 0;
    }
}

        async function fetchOrders() {
    showLoading();
    const params = getQueryParams();
    if (!params) return;

    try {
        // THÊM: Tính tổng tiền từ tất cả trang
        const totalAmountPromise = fetchTotalAmount();
        const ordersPromise = apiFetch(`/orders/completed/filtered?${params}`);
        
        const [totalAmount, response] = await Promise.all([totalAmountPromise, ordersPromise]);
        totalAmountAllPages = totalAmount; // LUU TỔNG TIỀN
        
        hideLoading();
        if (response.code === 0) {
            const data = response.result;
            renderOrderTable(data.content, data.totalElements);
            renderPagination(data.totalPages, data.number);
        } else {
            showNotification(response.message || 'Lỗi tải dữ liệu đơn hàng.', 'error');
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('orderTableBody').innerHTML = '';
        }
    } catch (error) {
        hideLoading();
        showNotification(error.message || 'Lỗi tải dữ liệu đơn hàng.', 'error');
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('orderTableBody').innerHTML = '';
    }
}

        function renderOrderTable(orders, totalElements = 0) {
            const tbody = document.getElementById('orderTableBody');
            
            const orderTableCard = document.querySelector('.card:has(#orderTable)');
            let totalOrdersElement = orderTableCard.querySelector('.total-orders-info');
            
            if (!totalOrdersElement) {
                totalOrdersElement = document.createElement('div');
                totalOrdersElement.className = 'total-orders-info alert alert-info mb-3';
                orderTableCard.querySelector('.card-body').insertBefore(totalOrdersElement, orderTableCard.querySelector('#loadingSpinner'));
            }

            
           totalOrdersElement.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <i class="fas fa-shopping-cart me-2"></i>
                <strong>Tổng số đơn hàng:</strong> ${totalElements.toLocaleString('vi-VN')} đơn
            </div>
            <div class="col-md-6">
                <i class="fas fa-money-bill-wave me-2"></i>
                <strong>Tổng doanh thu:</strong> <span class="text-success fw-bold">${formatCurrency(totalAmountAllPages)}</span>
            </div>
        </div>
    `;
    
    if (!orders || orders.length === 0) {
        document.getElementById('emptyState').style.display = 'block';
        tbody.innerHTML = '';
        return;
    }

               document.getElementById('emptyState').style.display = 'none';
    tbody.innerHTML = orders.map((order, index) => {
        const stt = currentPage * pageSize + index + 1;
        return `
            <tr>
                <td><div class="text-center fw-bold">${stt}</div></td>
                <td><div class="fw-bold">${order.id}</div></td>
                <td><div>${formatDate(order.createdAt)}</div></td>
                <td><div>${order.username || 'Khách lẻ'}</div></td>
                <td><div class="fw-bold text-success">${formatCurrency(order.totalAmount)}</div></td>
                <td><div>${order.orderType === 'DINE_IN' ? 'Tại quán' : order.orderType === 'TAKEAWAY' ? 'Mang về' : 'Giao hàng'}</div></td>
                <td><div>${formatPaymentMethod(order.paymentMethod)}</div></td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-outline-primary btn-sm" onclick="showOrderDetail(${order.id})" title="Xem chi tiết">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
        }

        function renderPagination(totalPages, currentPageIndex) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            if (!totalPages || totalPages <= 1) return;

            const prevDisabled = currentPageIndex === 0 ? 'disabled' : '';
            pagination.innerHTML += `
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${currentPageIndex - 1}); return false;">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>`;

            const startPage = Math.max(0, currentPageIndex - 2);
            const endPage = Math.min(totalPages - 1, currentPageIndex + 2);

            if (startPage > 0) {
                pagination.innerHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(0); return false;">1</a>
                    </li>`;
                if (startPage > 1) {
                    pagination.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const active = currentPageIndex === i ? 'active' : '';
                pagination.innerHTML += `
                    <li class="page-item ${active}">
                        <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i + 1}</a>
                    </li>`;
            }

            if (endPage < totalPages - 1) {
                if (endPage < totalPages - 2) {
                    pagination.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                pagination.innerHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${totalPages - 1}); return false;">${totalPages}</a>
                    </li>`;
            }

            const nextDisabled = currentPageIndex === totalPages - 1 ? 'disabled' : '';
            pagination.innerHTML += `
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${currentPageIndex + 1}); return false;">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>`;
        }

        function changePage(page) {
            if (page < 0) return;
            currentPage = page;
            fetchOrders();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function updateChart() {
            const period = document.getElementById('period').value;
            let params = '';
            
          if (period === 'custom') {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (!startDate || !endDate) return;
        
        // SỬA: Đổi từ period=custom thành period=specific và format UTC
        const startISO = `${startDate}T00:00:00Z`;
        const endISO = `${endDate}T23:59:59Z`;
        
        params = `period=specific&startDate=${encodeURIComponent(startISO)}&endDate=${encodeURIComponent(endISO)}`;
    } else {
        params = `period=${period}`;
    }


            try {
                const data = await apiFetch(`/orders/summary?${params}`);
                if (summaryChart) summaryChart.destroy();
                const ctx = document.getElementById('summaryChart').getContext('2d');
                
                const originalLabels = data.result.labels;
                const processedLabels = data.result.labels.map(label => {
                    const [year, month, day] = label.split('-');
                    return `${day}/${month}`;
                });
                
                summaryChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: processedLabels,
                        datasets: [{
                            label: 'Số đơn hoàn thành',
                            data: data.result.quantities,
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderColor: '#22c55e',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#22c55e',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: { 
                                display: true,
                                labels: {
                                    color: '#1f2937',
                                    font: {
                                        size: 14,
                                        weight: '600'
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                borderColor: '#22c55e',
                                borderWidth: 1,
                                callbacks: {
                                    title: function(context) {
                                        const index = context[0].dataIndex;
                                        return originalLabels[index];
                                    },
                                    label: function(context) {
                                        return `${context.label}: ${context.parsed.y} đơn`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { 
                                    color: '#6b7280',
                                    font: {
                                        size: 12
                                    }
                                },
                                grid: { 
                                    color: '#e5e7eb',
                                    drawBorder: false
                                },
                                title: {
                                    display: true,
                                    text: 'Ngày',
                                    color: '#1f2937',
                                    font: { size: 14, weight: '600' }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#6b7280',
                                    font: {
                                        size: 12
                                    },
                                    stepSize: 1,
                                    callback: value => value.toLocaleString('vi-VN')
                                },
                                grid: { 
                                    color: '#e5e7eb',
                                    drawBorder: false
                                },
                                title: {
                                    display: true,
                                    text: 'Số đơn',
                                    color: '#1f2937',
                                    font: { size: 14, weight: '600' }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Lỗi tải biểu đồ:', error);
                showNotification('Lỗi tải biểu đồ.', 'error');
            }
        }

        async function showOrderDetail(orderId) {
            try {
                const data = await apiFetch(`/orders/${orderId}`);
                const order = data.result;
        
                document.getElementById('orderDetailModalLabel').textContent = `Chi tiết đơn hàng ${order.id}`;
                document.getElementById('orderDetails').innerHTML = `
                    <div class="col-md-6">
                        <p><strong>Mã:</strong> ${order.id}</p>
                        <p><strong>Ngày đặt:</strong> ${formatDate(order.createdAt)}</p>
                        <p><strong>Khách hàng:</strong> ${order.username || 'Khách lẻ'}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Tổng tiền:</strong> ${formatCurrency(order.totalAmount)}</p>
                        <p><strong>Loại đơn:</strong> ${order.orderType === 'DINE_IN' ? 'Tại quán' : order.orderType === 'TAKEAWAY' ? 'Mang về' : 'Giao hàng'}</p>
                        <p><strong>Bàn:</strong> ${order.tableNumber || 'N/A'}</p>
                        <p><strong>Phương thức thanh toán:</strong> ${formatPaymentMethod(order.payment.paymentMethod)}</p>
                    </div>
                `;
                document.getElementById('itemsTableBody').innerHTML = order.orderItems.map(item => `
                    <tr>
                        <td>${item.menuItemName}</td>
                        <td>${item.quantity}</td>
                        <td>${formatCurrency(item.price)}</td>
                        <td>${formatCurrency(item.quantity * item.price)}</td>
                    </tr>
                `).join('');
                document.getElementById('orderNote').innerHTML = order.note ? `<strong>Ghi chú:</strong> ${order.note}` : '';
                new bootstrap.Modal(document.getElementById('orderDetailModal')).show();
            } catch (error) {
                showNotification(`Không thể tải chi tiết đơn hàng: ${error.message}`, 'error');
            }
        }

        function sortTable(column) {
    // Xóa tất cả class sort cũ
    document.querySelectorAll('.sort-arrow').forEach(arrow => {
        arrow.className = 'sort-arrow';
    });
    
    if (sortBy === column) {
        sortDirection = sortDirection === 'ASC' ? 'DESC' : 'ASC';
    } else {
        sortBy = column;
        sortDirection = 'ASC';
    }
    
    // Thêm class cho cột đang sort
    const currentArrow = document.getElementById(`sort-${column}`);
    if (currentArrow) {
        currentArrow.className = `sort-arrow ${sortDirection.toLowerCase()}`;
    }
    
    fetchOrders();
}

       function initPeriodFromQueryParams() {
    const urlParams = new URLSearchParams(window.location.search);
    const period = urlParams.get('period') || 'month';
    const specificDate = urlParams.get('specificDate');
    const startDate = urlParams.get('startDate');
    const endDate = urlParams.get('endDate');
    
    const periodSelect = document.getElementById('period');
    
    // SỬA: Xử lý trường hợp từ dashboard chuyển sang với period=custom
    if (period === 'custom' && startDate && endDate && startDate === endDate) {
        // Trường hợp từ dashboard specific date
        periodSelect.value = 'custom';
        document.getElementById('customDate').style.display = 'block';
        document.getElementById('startDate').value = startDate;
        document.getElementById('endDate').value = endDate;
    } else if (period === 'specific' && specificDate) {
        // Trường hợp cũ (để tương thích ngược)
        periodSelect.value = 'custom';
        document.getElementById('customDate').style.display = 'block';
        document.getElementById('startDate').value = specificDate;
        document.getElementById('endDate').value = specificDate;
    } else {
        periodSelect.value = period === 'specific' ? 'custom' : period;
        document.getElementById('customDate').style.display = period === 'custom' ? 'block' : 'none';
    }
}
        async function updateData() {
            await Promise.all([fetchOrders(), updateChart()]);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadSidebar();
            initPeriodFromQueryParams();
            updateData();

            const filterForm = document.getElementById('filterForm');
            filterForm.addEventListener('submit', (e) => {
                e.preventDefault();
                currentPage = 0;
                updateData();
            });

            document.getElementById('period').addEventListener('change', function() {
                document.getElementById('customDate').style.display = this.value === 'custom' ? 'block' : 'none';
                if (this.value !== 'custom') {
                    currentPage = 0;
                    updateData();
                }
            });

            document.getElementById('startDate').addEventListener('change', function() {
                if (document.getElementById('period').value === 'custom') {
                    currentPage = 0;
                    updateData();
                }
            });

            document.getElementById('endDate').addEventListener('change', function() {
                if (document.getElementById('period').value === 'custom') {
                    currentPage = 0;
                    updateData();
                }
            });

            document.getElementById('searchInput').addEventListener('input', function() {
                currentPage = 0;
                updateData();
            });

            document.getElementById('orderTypeFilter').addEventListener('change', function() {
                currentPage = 0;
                updateData();
            });

            document.getElementById('minPrice').addEventListener('input', function() {
                currentPage = 0;
                updateData();
            });

            document.getElementById('maxPrice').addEventListener('input', function() {
                currentPage = 0;
                updateData();
            });

            document.getElementById('paymentMethodFilter').addEventListener('change', function() {
                currentPage = 0;
                updateData();
            });
        });

        setInterval(updateData, 5 * 60 * 1000);
    </script>
</body>
</html>