<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodHub Admin - Quản lý hệ thống</title>
    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600&family=Nunito:wght@600;700;800&family=Pacifico&display=swap" rel="stylesheet">
    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/sidebar.css">
    <style>
        :root {
            --primary: #FEA116;
            --light: #F1F8FF;
            --dark: #0F172B;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--light);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: #121826;
        }

        .main-content {
            margin-left: 280px;
            transition: all 0.3s;
            min-height: 100vh;
        }

        .main-content.expanded {
            margin-left: 70px;
        }

        .top-bar {
            background: #fff;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle-sidebar {
            background: none;
            border: none;
            color: var(--dark);
            font-size: 1.2rem;
        }

        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px;
        }

        .card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            text-align: left;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: scale(1.03);
            cursor: pointer;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .card-header h5 {
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 600;
            margin: 0;
        }

        .card-body {
            padding: 0;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: #121826;
            margin-bottom: 5px;
        }

        .btn-manage {
            background: var(--primary);
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 25px;
            color: white;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-manage:hover {
            background: #e8960f;
            color: white;
        }

        .welcome-section {
            background: #f9fafb;
            padding: 2rem;
            margin: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .welcome-section h2 {
            color: var(--primary);
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .welcome-section p {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .management-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .error {
            text-align: center;
            padding: 15px;
            color: #f87171;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            margin: 15px 20px;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1200px) {
            .dashboard-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
            }
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            .welcome-section h2 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Include -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="d-flex align-items-center">
                <button class="toggle-sidebar me-3" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h4 class="mb-0" id="pageTitle"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h4>
            </div>
            <div class="d-flex align-items-center">
                <div class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle me-2"></i>Admin
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>Hồ sơ</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Cài đặt</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt me-2"></i>Đăng xuất</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent">
            <!-- Welcome Section -->
            <div class="welcome-section">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="mb-3">Chào mừng đến với FoodHub Admin</h2>
                        <p class="mb-0">Quản lý toàn bộ hệ thống nhà hàng của bạn một cách hiệu quả và dễ dàng.</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <i class="fas fa-utensils management-icon"></i>
                    </div>
                </div>
            </div>

            <!-- Dashboard Cards -->
            <div class="dashboard-cards">
                <!-- Customer Management Card -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-users me-2"></i>Quản lý khách hàng</h5>
                    </div>
                    <div class="card-body text-center">
                        <i class="fas fa-users management-icon"></i>
                        <div class="stats-number" id="customerCount"><span class="loading-spinner"></span>Đang tải...</div>
                        <p class="text-muted mb-3">Tổng số khách hàng</p>
                        <button class="btn btn-manage" onclick="showCustomerManagement()">
                            <i class="fas fa-cog me-2"></i>Quản lý
                        </button>
                    </div>
                </div>

                <!-- Staff Management Card -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-user-tie me-2"></i>Quản lý nhân viên</h5>
                    </div>
                    <div class="card-body text-center">
                        <i class="fas fa-user-tie management-icon"></i>
                        <div class="stats-number" id="userCount"><span class="loading-spinner"></span>Đang tải...</div>
                        <p class="text-muted mb-3">Tổng số nhân viên</p>
                        <button class="btn btn-manage" onclick="showStaffManagement()">
                            <i class="fas fa-cog me-2"></i>Quản lý
                        </button>
                    </div>
                </div>

                <!-- Menu Management Card -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-utensils me-2"></i>Quản lý món ăn</h5>
                    </div>
                    <div class="card-body text-center">
                        <i class="fas fa-utensils management-icon"></i>
                        <div class="stats-number" id="menuItemCount"><span class="loading-spinner"></span>Đang tải...</div>
                        <p class="text-muted mb-3">Tổng số món ăn</p>
                        <button class="btn btn-manage" onclick="showMenuManagement()">
                            <i class="fas fa-cog me-2"></i>Quản lý
                        </button>
                    </div>
                </div>

                <!-- Finance Management Card -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-money-bill-wave me-2"></i>Quản lý tài chính</h5>
                    </div>
                    <div class="card-body text-center">
                        <i class="fas fa-money-bill-wave management-icon"></i>
                        <div class="stats-number" id="todayRevenue"><span class="loading-spinner"></span>Đang tải...</div>
                        <p class="text-muted mb-3">Doanh thu hôm nay</p>
                        <button class="btn btn-manage" onclick="showFinanceManagement()">
                            <i class="fas fa-cog me-2"></i>Quản lý
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dynamic Content Area -->
        <div id="dynamicContent" style="display: none;"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="/js/fetch-api.js"></script>
    <script src="/js/sidebar.js"></script>
    <script>
        // Hàm tải sidebar
        async function loadSidebar() {
            try {
                const response = await fetch('/components/sidebar.html');
                if (!response.ok) throw new Error('Không thể tải sidebar');
                const sidebarHtml = await response.text();
                document.getElementById('sidebar-container').innerHTML = sidebarHtml;
                setActiveNavLink();
            } catch (error) {
                console.error('Lỗi khi tải sidebar:', error);
                showNotification('Lỗi tải sidebar!', 'error');
                document.getElementById('sidebar-container').innerHTML = '<p>Lỗi khi tải sidebar!</p>';
            }
        }

        // Hàm định dạng tiền tệ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Hàm hiển thị thông báo
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show notification`;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '10000';
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        // Hàm ẩn thông báo lỗi
        function hideError() {
            const existingError = document.querySelector('.notification.alert-danger');
            if (existingError) existingError.remove();
        }

        // Hàm toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        }

        // Hàm set active nav
        function setActiveNav(element) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            if (element) {
                element.classList.add('active');
            } else {
                console.warn('Không tìm thấy phần tử nav để set active.');
            }
        }

        // Hàm đăng xuất
        function handleLogout() {
            if (confirm('Bạn có chắc chắn muốn đăng xuất khỏi hệ thống?')) {
                document.body.style.opacity = '0.5';
                document.body.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    alert('Đã đăng xuất thành công!');
                    document.body.style.opacity = '1';
                }, 1000);
            }
        }

        // Hàm hiển thị dashboard
        function showDashboard() {
            document.getElementById('pageTitle').innerHTML = '<i class="fas fa-tachometer-alt me-2"></i>Dashboard';
            document.getElementById('dashboardContent').style.display = 'block';
            document.getElementById('dynamicContent').style.display = 'none';
            const navElement = document.querySelector('[onclick="showDashboard()"]');
            if (navElement) {
                setActiveNav(navElement);
            }
            fetchDashboardData();
        }

        // Hàm điều hướng
        function showMenuManagement() {
            window.location.href = "/menu-manager/menu.html";
        }

        function showStaffManagement() {
            window.location.href = "/staff-manager/staffList.html";
        }

        function showFinanceManagement() {
            window.location.href = "/revenue-report/revenue-report.html";
        }

        function showCustomerManagement() {
            window.location.href = "/customer-manager/customerList.html";
        }

        function showOrders() {
            window.location.href = "/orders.html";
        }

        // Hàm fetch số lượng khách hàng
        async function fetchCustomerCount() {
            const customerCountElement = document.getElementById('customerCount');
            customerCountElement.innerHTML = '<span class="loading-spinner"></span>Đang tải...';
            const timeoutId = setTimeout(() => {
                customerCountElement.textContent = 'N/A';
                showNotification('Không thể tải số lượng khách hàng. Hết thời gian chờ.', 'error');
            }, 10000);

            try {
                const response = await apiFetch('/users/countCustomers');
                console.log('Phản hồi khách hàng:', response);
                if (response.code !== 1000) throw new Error(response.message || 'Không thể tải số lượng khách hàng!');
                const count = typeof response.result === 'object' ? response.result.count : response.result;
                customerCountElement.textContent = count.toLocaleString('vi-VN');
                hideError();
            } catch (error) {
                console.error('Lỗi fetchCustomerCount:', error);
                customerCountElement.textContent = 'N/A';
                showNotification(error.message, 'error');
            } finally {
                clearTimeout(timeoutId);
            }
        }

        // Hàm fetch số lượng nhân viên
        async function fetchUserCount() {
            const userCountElement = document.getElementById('userCount');
            userCountElement.innerHTML = '<span class="loading-spinner"></span>Đang tải...';
            const timeoutId = setTimeout(() => {
                userCountElement.textContent = 'N/A';
                showNotification('Không thể tải số lượng nhân viên. Hết thời gian chờ.', 'error');
            }, 10000);

            try {
                const response = await apiFetch('/users/countEmployees');
                console.log('Phản hồi nhân viên:', response);
                if (response.code !== 1000) throw new Error(response.message || 'Không thể tải số lượng nhân viên!');
                const count = typeof response.result === 'object' ? response.result.count : response.result;
                userCountElement.textContent = count.toLocaleString('vi-VN');
                hideError();
            } catch (error) {
                console.error('Lỗi fetchUserCount:', error);
                userCountElement.textContent = 'N/A';
                showNotification(error.message, 'error');
            } finally {
                clearTimeout(timeoutId);
            }
        }

        // Hàm fetch số lượng món ăn
        async function fetchMenuItemCount() {
            const menuItemCountElement = document.getElementById('menuItemCount');
            menuItemCountElement.innerHTML = '<span class="loading-spinner"></span>Đang tải...';
            const timeoutId = setTimeout(() => {
                menuItemCountElement.textContent = 'N/A';
                showNotification('Không thể tải số lượng món ăn. Hết thời gian chờ.', 'error');
            }, 10000);

            try {
                const response = await apiFetch('/menu-items/count');
                console.log('Phản hồi món ăn:', response);
                if (response.code !== 1000) throw new Error(response.message || 'Không thể tải số lượng món ăn!');
                const count = typeof response.result === 'object' ? response.result.count : response.result;
                menuItemCountElement.textContent = count.toLocaleString('vi-VN');
                hideError();
            } catch (error) {
                console.error('Lỗi fetchMenuItemCount:', error);
                menuItemCountElement.textContent = 'N/A';
                showNotification(error.message, 'error');
            } finally {
                clearTimeout(timeoutId);
            }
        }

        // Hàm fetch doanh thu hôm nay
        async function fetchTodayRevenue() {
            const revenueElement = document.getElementById('todayRevenue');
            revenueElement.innerHTML = '<span class="loading-spinner"></span>Đang tải...';
            const timeoutId = setTimeout(() => {
                revenueElement.textContent = formatCurrency(0);
                showNotification('Không thể tải doanh thu hôm nay. Hết thời gian chờ.', 'error');
            }, 10000);

            try {
                const response = await apiFetch('/dashboard?period=today');
                console.log('Phản hồi doanh thu:', response);
                if (response.code !== 1000) throw new Error(response.message || 'Không thể tải doanh thu hôm nay!');
                revenueElement.textContent = formatCurrency(response.result.revenue);
                hideError();
            } catch (error) {
                console.error('Lỗi fetchTodayRevenue:', error);
                revenueElement.textContent = formatCurrency(0);
                showNotification(error.message, 'error');
            } finally {
                clearTimeout(timeoutId);
            }
        }

        // Hàm tải dữ liệu dashboard
        async function fetchDashboardData() {
            console.log('Bắt đầu tải dữ liệu dashboard...');
            fetchCustomerCount().catch(error => console.error('Lỗi fetchCustomerCount:', error));
            fetchUserCount().catch(error => console.error('Lỗi fetchUserCount:', error));
            fetchMenuItemCount().catch(error => console.error('Lỗi fetchMenuItemCount:', error));
            fetchTodayRevenue().catch(error => console.error('Lỗi fetchTodayRevenue:', error));
            console.log('Đã gửi tất cả yêu cầu fetch.');
        }

        // Sự kiện DOM loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Kiểm tra DOM
            console.log('Kiểm tra DOM:', {
                customerCount: document.getElementById('customerCount'),
                userCount: document.getElementById('userCount'),
                menuItemCount: document.getElementById('menuItemCount'),
                todayRevenue: document.getElementById('todayRevenue')
            });

            // Xóa accessToken
            localStorage.removeItem("accessToken");
            console.log("Đã xóa accessToken:", localStorage.getItem("accessToken"));

            loadSidebar();
            showDashboard();
        });
    </script>
</body>
</html>